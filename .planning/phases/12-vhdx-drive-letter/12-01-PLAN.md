---
phase: 12-vhdx-drive-letter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1
  - FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1
  - Tests/Unit/FFU.Imaging.DriveLetterStability.Tests.ps1
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Set-OSPartitionDriveLetter assigns drive letter to OS partition when missing"
    - "Set-OSPartitionDriveLetter returns existing drive letter if already assigned"
    - "Function prefers W: drive letter but falls back to other available letters"
    - "Function re-fetches partition after assignment to confirm drive letter"
  artifacts:
    - path: "FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1"
      provides: "Set-OSPartitionDriveLetter utility function"
      contains: "function Set-OSPartitionDriveLetter"
    - path: "FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1"
      provides: "Updated exports including Set-OSPartitionDriveLetter"
      contains: "Set-OSPartitionDriveLetter"
    - path: "Tests/Unit/FFU.Imaging.DriveLetterStability.Tests.ps1"
      provides: "Unit tests for drive letter stability"
      contains: "Set-OSPartitionDriveLetter"
  key_links:
    - from: "FFU.Imaging.psm1"
      to: "Get-Partition"
      via: "Windows Storage cmdlet call"
      pattern: "Get-Partition"
    - from: "FFU.Imaging.psm1"
      to: "Set-Partition"
      via: "Drive letter assignment"
      pattern: "Set-Partition.*-NewDriveLetter"
---

<objective>
Create centralized Set-OSPartitionDriveLetter utility function for guaranteed drive letter assignment after any mount operation.

Purpose: The root cause of drive letter loss is that Windows VHDX/VHD assignments are ephemeral - lost on dismount/remount. This function provides a single, reusable solution that assigns a drive letter to the OS partition, handling cases where the partition has no letter or already has one.

Output: Exported Set-OSPartitionDriveLetter function in FFU.Imaging module with comprehensive logging and unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-vhdx-drive-letter/12-RESEARCH.md

# Existing patterns to follow
@FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1
@FFUDevelopment/BuildFFUVM.ps1 (lines 4226-4253 for existing workaround pattern)
@FFUDevelopment/Modules/FFU.Hypervisor/Private/New-VHDWithDiskpart.ps1 (Set-VHDDriveLetter pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Set-OSPartitionDriveLetter function to FFU.Imaging</name>
  <files>FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1</files>
  <action>
Add the Set-OSPartitionDriveLetter function to FFU.Imaging.psm1. Place it after the existing partition-related functions (after New-RecoveryPartition, around line 1500).

Function requirements:
1. Accept disk object (CimInstance or PSCustomObject for diskpart fallback)
2. Accept optional PreferredLetter parameter (defaults to 'W')
3. Find OS partition by GPT type {ebd0a0a2-b9e5-4433-87c0-68b6b72699c7}
4. Return existing drive letter if already assigned (no-op)
5. If no drive letter, assign preferred letter if available, otherwise find next available (Z downward)
6. Re-fetch partition after assignment to confirm drive letter
7. Include retry logic (3 attempts) for resilience
8. Comprehensive logging for debugging

Function signature:
```powershell
function Set-OSPartitionDriveLetter {
    [CmdletBinding()]
    [OutputType([char])]
    param(
        [Parameter(Mandatory = $true)]
        $Disk,

        [Parameter(Mandatory = $false)]
        [char]$PreferredLetter = 'W',

        [Parameter(Mandatory = $false)]
        [int]$RetryCount = 3
    )
}
```

Key implementation patterns (adapted from BuildFFUVM.ps1 lines 4226-4253):
- Use `Get-Volume).DriveLetter` to find used letters
- Use `[char[]](90..68)` for Z-to-D iteration (avoid A-C which are reserved)
- Use `Set-Partition -NewDriveLetter` for assignment
- Wait 500ms after assignment for Windows to complete
- Re-fetch partition with `Get-Partition -DriveLetter $letter` to verify
- Throw on failure after all retries exhausted

Logging requirements:
- Log entry with disk number
- Log if partition already has drive letter (return early)
- Log letter selection (preferred vs fallback)
- Log each assignment attempt
- Log success with final drive letter
  </action>
  <verify>
```powershell
# Function exists and is properly defined
$module = Get-Content "FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1" -Raw
$module -match 'function Set-OSPartitionDriveLetter' | Should -Be $true
$module -match '\[OutputType\(\[char\]\)\]' | Should -Be $true
$module -match 'PreferredLetter' | Should -Be $true
$module -match 'ebd0a0a2-b9e5-4433-87c0-68b6b72699c7' | Should -Be $true
```
  </verify>
  <done>Set-OSPartitionDriveLetter function added with disk parameter, preferred letter support, retry logic, and comprehensive logging</done>
</task>

<task type="auto">
  <name>Task 2: Export function and update module manifest</name>
  <files>
    FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1
    FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1
  </files>
  <action>
1. In FFU.Imaging.psd1:
   - Add 'Set-OSPartitionDriveLetter' to FunctionsToExport array (after Expand-FFUPartitionForDrivers)
   - Bump ModuleVersion from 1.0.11 to 1.0.12
   - Add release note:
```
v1.0.12 - VHDX-01: Add Set-OSPartitionDriveLetter for guaranteed drive letter assignment
- New centralized utility function for OS partition drive letter management
- Handles both already-assigned and missing drive letter cases
- Preferred letter support (default: W) with automatic fallback
- Retry logic (3 attempts) for resilience against transient failures
- Addresses drive letter loss during VHDX/VHD dismount/remount cycles
```

2. Verify the function is properly scoped for export (no `private:` prefix, at module scope)
  </action>
  <verify>
```powershell
# Verify manifest
$manifest = Import-PowerShellDataFile "FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1"
$manifest.FunctionsToExport -contains 'Set-OSPartitionDriveLetter' | Should -Be $true
$manifest.ModuleVersion | Should -Be '1.0.12'

# Verify function exports
Import-Module "FFUDevelopment/Modules/FFU.Imaging" -Force
Get-Command -Module FFU.Imaging -Name Set-OSPartitionDriveLetter | Should -Not -BeNullOrEmpty
```
  </verify>
  <done>Function exported in manifest, module version bumped to 1.0.12 with release notes</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for Set-OSPartitionDriveLetter</name>
  <files>Tests/Unit/FFU.Imaging.DriveLetterStability.Tests.ps1</files>
  <action>
Create new test file Tests/Unit/FFU.Imaging.DriveLetterStability.Tests.ps1 with Pester 5.x tests.

Test scenarios:
1. Returns existing drive letter when already assigned (no-op case)
2. Assigns preferred letter when available
3. Falls back to next available letter when preferred is in use
4. Re-fetches partition to confirm assignment
5. Throws when no OS partition found
6. Throws when no available drive letters
7. Retries on transient failures

Test structure:
```powershell
BeforeAll {
    # Mock WriteLog to avoid FFU.Core dependency
    function WriteLog { param($Message) }

    # Import module
    Import-Module "$PSScriptRoot/../../FFUDevelopment/Modules/FFU.Imaging" -Force
}

Describe 'Set-OSPartitionDriveLetter' {
    Context 'When OS partition already has drive letter' {
        # Mock scenario and test return value
    }

    Context 'When OS partition has no drive letter' {
        # Mock scenario and test assignment
    }

    Context 'When preferred letter is unavailable' {
        # Mock scenario and test fallback
    }

    Context 'When no OS partition exists' {
        # Mock scenario and test exception
    }
}
```

Use appropriate mocks for:
- Get-Partition (return mock partition with/without DriveLetter)
- Get-Volume (return mock list of used letters)
- Set-Partition (mock successful assignment)
- Start-Sleep (mock to skip delay)
  </action>
  <verify>
```powershell
# Run Pester tests
$result = Invoke-Pester -Path "Tests/Unit/FFU.Imaging.DriveLetterStability.Tests.ps1" -PassThru
$result.FailedCount | Should -Be 0
```
  </verify>
  <done>Pester tests created covering all scenarios: existing letter, assignment, fallback, errors</done>
</task>

</tasks>

<verification>
1. Module imports successfully:
```powershell
Import-Module "FFUDevelopment/Modules/FFU.Imaging" -Force -ErrorAction Stop
```

2. Function is exported:
```powershell
Get-Command -Module FFU.Imaging -Name Set-OSPartitionDriveLetter
```

3. Function has correct parameters:
```powershell
$cmd = Get-Command Set-OSPartitionDriveLetter
$cmd.Parameters.Keys -contains 'Disk' | Should -Be $true
$cmd.Parameters.Keys -contains 'PreferredLetter' | Should -Be $true
$cmd.Parameters.Keys -contains 'RetryCount' | Should -Be $true
```

4. Unit tests pass:
```powershell
Invoke-Pester -Path "Tests/Unit/FFU.Imaging.DriveLetterStability.Tests.ps1" -PassThru
```
</verification>

<success_criteria>
- [ ] Set-OSPartitionDriveLetter function added to FFU.Imaging.psm1
- [ ] Function accepts Disk, PreferredLetter, RetryCount parameters
- [ ] Function returns existing letter when already assigned
- [ ] Function assigns and verifies drive letter when missing
- [ ] Function uses preferred letter (W) or falls back to available
- [ ] FunctionsToExport includes Set-OSPartitionDriveLetter
- [ ] Module version bumped to 1.0.12
- [ ] Unit tests pass (all scenarios covered)
</success_criteria>

<output>
After completion, create `.planning/phases/12-vhdx-drive-letter/12-01-SUMMARY.md`
</output>
