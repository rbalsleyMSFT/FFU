---
phase: 11-windows-update-filtering
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - FFUDevelopment/BuildFFUVM_UI.xaml
  - FFUDevelopment/FFUUI.Core/FFUUI.Core.Initialize.psm1
  - FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1
  - FFUDevelopment/BuildFFUVM.ps1
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see Include Preview Updates checkbox in Updates tab"
    - "Checkbox state persists when saving/loading config"
    - "Build script excludes preview updates when checkbox unchecked"
    - "Build script includes preview updates when checkbox checked"
  artifacts:
    - path: "FFUDevelopment/BuildFFUVM_UI.xaml"
      provides: "UI checkbox control"
      contains: "chkIncludePreviewUpdates"
    - path: "FFUDevelopment/FFUUI.Core/FFUUI.Core.Initialize.psm1"
      provides: "Control registration"
      contains: "chkIncludePreviewUpdates"
    - path: "FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1"
      provides: "Config save/load mapping"
      contains: "IncludePreviewUpdates"
    - path: "FFUDevelopment/BuildFFUVM.ps1"
      provides: "Preview filter logic"
      contains: "IncludePreviewUpdates"
  key_links:
    - from: "BuildFFUVM_UI.xaml"
      to: "FFUUI.Core.Initialize.psm1"
      via: "FindName binding"
      pattern: "chkIncludePreviewUpdates"
    - from: "FFUUI.Core.Config.psm1"
      to: "BuildFFUVM.ps1"
      via: "parameter passing"
      pattern: "IncludePreviewUpdates"
---

<objective>
Implement UI checkbox for preview update opt-in and build script filtering logic.

Purpose: Enable users to control whether preview updates are included in Windows Update searches. Default behavior (unchecked) excludes preview updates for production-safe builds.

Output: Working end-to-end feature from UI checkbox through config persistence to build script filtering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-windows-update-filtering/11-RESEARCH.md
@.planning/phases/11-windows-update-filtering/11-01-SUMMARY.md

# Existing patterns to follow
@FFUDevelopment/BuildFFUVM_UI.xaml (lines 268-280 for Updates tab)
@FFUDevelopment/FFUUI.Core/FFUUI.Core.Initialize.psm1 (lines 160-170 for control registration)
@FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1 (lines 105-115 for config mapping)
@FFUDevelopment/BuildFFUVM.ps1 (lines 458-465 for update params, lines 3478-3550 for search logic)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UI checkbox to Updates tab</name>
  <files>
    FFUDevelopment/BuildFFUVM_UI.xaml
    FFUDevelopment/FFUUI.Core/FFUUI.Core.Initialize.psm1
  </files>
  <action>
1. In BuildFFUVM_UI.xaml, add checkbox after chkUpdatePreviewCU (line 279):
```xml
<CheckBox x:Name="chkIncludePreviewUpdates"
          Content="Include Preview Updates in Search"
          Margin="5"
          VerticalAlignment="Center"
          ToolTip="When checked, allows preview/optional updates to appear in update searches. When unchecked (default), only GA (Generally Available) releases are found. This affects Cumulative Updates and .NET Framework updates."/>
```

2. In FFUUI.Core.Initialize.psm1:
   - Add control registration near line 165 (after chkUpdatePreviewCU):
     ```powershell
     $State.Controls.chkIncludePreviewUpdates = $window.FindName('chkIncludePreviewUpdates')
     ```
   - Add default initialization near line 310 (after UpdatePreviewCU default):
     ```powershell
     $State.Controls.chkIncludePreviewUpdates.IsChecked = $State.Defaults.generalDefaults.IncludePreviewUpdates
     ```

Note: The default will be false since schema default is false and new configs inherit schema defaults.
  </action>
  <verify>
Verify XAML is valid (no parsing errors):
```powershell
[xml]$xaml = Get-Content "FFUDevelopment/BuildFFUVM_UI.xaml" -Raw
$checkbox = $xaml.SelectSingleNode("//*[@Name='chkIncludePreviewUpdates']")
$checkbox -ne $null
```
Verify Initialize module contains control registration:
```powershell
$content = Get-Content "FFUDevelopment/FFUUI.Core/FFUUI.Core.Initialize.psm1" -Raw
$content -match 'chkIncludePreviewUpdates'
```
  </verify>
  <done>Updates tab contains "Include Preview Updates in Search" checkbox with tooltip explaining behavior</done>
</task>

<task type="auto">
  <name>Task 2: Wire checkbox to config save/load</name>
  <files>FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1</files>
  <action>
1. In Build-ConfigFromUI function (around line 109, after UpdatePreviewCU mapping):
   Add the checkbox state to config hash:
   ```powershell
   IncludePreviewUpdates          = $State.Controls.chkIncludePreviewUpdates.IsChecked
   ```

2. In Update-UIFromConfig function (around line 563, after UpdatePreviewCU Set-UIValue):
   Add the config-to-UI binding:
   ```powershell
   Set-UIValue -ControlName 'chkIncludePreviewUpdates' -PropertyName 'IsChecked' -ConfigObject $ConfigContent -ConfigKey 'IncludePreviewUpdates' -State $State
   ```

Follow the exact pattern used for UpdatePreviewCU - no special handler needed since simple checkbox state flows through existing infrastructure.
  </action>
  <verify>
Verify config module contains mappings:
```powershell
$content = Get-Content "FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1" -Raw
$content -match 'IncludePreviewUpdates\s*=\s*\$State\.Controls\.chkIncludePreviewUpdates\.IsChecked'
$content -match "Set-UIValue.*chkIncludePreviewUpdates.*IncludePreviewUpdates"
```
  </verify>
  <done>Checkbox state persists through config save/load cycle</done>
</task>

<task type="auto">
  <name>Task 3: Add parameter and filtering logic to BuildFFUVM.ps1</name>
  <files>FFUDevelopment/BuildFFUVM.ps1</files>
  <action>
1. Add parameter to param block (after UpdatePreviewCU at line 459):
   ```powershell
   [bool]$IncludePreviewUpdates,
   ```

2. Add help text in comment-based help (after .PARAMETER UpdatePreviewCU around line 201):
   ```
   .PARAMETER IncludePreviewUpdates
   When set to $true, allows preview/optional updates in Windows Update searches. When $false (default), search queries exclude preview updates to ensure only GA (Generally Available) releases are downloaded. Affects Cumulative Updates and .NET Framework updates.
   ```

3. Modify update search logic (around line 3478). Before the CU search block, add:
   ```powershell
   # Apply preview exclusion filter when IncludePreviewUpdates is false
   $PreviewFilter = if ($IncludePreviewUpdates -eq $false) { " -preview" } else { "" }
   if ($IncludePreviewUpdates -eq $false) {
       WriteLog "Preview updates will be excluded from search results (IncludePreviewUpdates=$false)"
   } else {
       WriteLog "Preview updates may be included in search results (IncludePreviewUpdates=$true)"
   }
   ```

4. Modify CU search queries to append filter (lines 3480-3488):
   - Line 3480: Change to `$Name = """Cumulative update for Windows $WindowsRelease Version $WindowsVersion for $WindowsArch""$PreviewFilter"`
   - Line 3481: Change to `$Name = """Cumulative Update for Microsoft server operating system, version 24h2 for $WindowsArch""$PreviewFilter"`
   - Line 3482: Change to `$Name = """Cumulative Update for Microsoft server operating system, version 21h2 for $WindowsArch""$PreviewFilter"`
   - Line 3483: Change to `$Name = """Cumulative update for Windows Server $WindowsRelease for $WindowsArch""$PreviewFilter"`
   - Lines 3486-3488: Add $PreviewFilter to each $Name assignment

5. Modify .NET search queries to use $PreviewFilter instead of hardcoded "-preview" (lines 3529-3534):
   - Line 3529: Change `...-preview"` to `...$PreviewFilter"`
   - Line 3530: Change `...-preview"` to `...$PreviewFilter"`
   - Line 3531: Change `...-preview"` to `...$PreviewFilter"`

   This makes .NET preview filtering consistent with the user setting instead of always excluding.

IMPORTANT: Do NOT apply preview filter to:
- UpdatePreviewCU searches (line 3502) - this is an EXPLICIT preview request
- Defender, MSRT, Edge, OneDrive, Microcode - these don't have preview variants
  </action>
  <verify>
Verify parameter exists:
```powershell
$ast = [System.Management.Automation.Language.Parser]::ParseFile("FFUDevelopment/BuildFFUVM.ps1", [ref]$null, [ref]$null)
$params = $ast.ParamBlock.Parameters | ForEach-Object { $_.Name.VariablePath.UserPath }
$params -contains 'IncludePreviewUpdates'
```
Verify filter logic exists:
```powershell
$content = Get-Content "FFUDevelopment/BuildFFUVM.ps1" -Raw
$content -match '\$PreviewFilter.*IncludePreviewUpdates'
```
  </verify>
  <done>
Build script has IncludePreviewUpdates parameter that controls whether "-preview" exclusion filter is applied to CU and .NET searches
  </done>
</task>

</tasks>

<verification>
1. XAML parses without errors:
```powershell
[xml]$xaml = Get-Content "FFUDevelopment/BuildFFUVM_UI.xaml" -Raw
```

2. All modules import cleanly:
```powershell
Import-Module "FFUDevelopment/FFUUI.Core/FFUUI.Core.psd1" -Force
Import-Module "FFUDevelopment/Modules/FFU.ConfigMigration" -Force
```

3. Parameter exists in BuildFFUVM.ps1:
```powershell
$help = Get-Help "FFUDevelopment/BuildFFUVM.ps1" -Parameter IncludePreviewUpdates -ErrorAction SilentlyContinue
$help -ne $null
```

4. End-to-end flow validation (manual):
- Launch UI, go to Updates tab
- Verify "Include Preview Updates in Search" checkbox is visible
- Check/uncheck box, save config, reload config - verify state persists
</verification>

<success_criteria>
- [ ] chkIncludePreviewUpdates checkbox visible in Updates tab
- [ ] Checkbox tooltip explains GA vs preview behavior
- [ ] Checkbox state included in Build-ConfigFromUI output
- [ ] Update-UIFromConfig loads IncludePreviewUpdates from saved config
- [ ] BuildFFUVM.ps1 has IncludePreviewUpdates parameter
- [ ] Build script applies -preview filter when IncludePreviewUpdates=$false
- [ ] Build script skips filter when IncludePreviewUpdates=$true
- [ ] UpdatePreviewCU explicit search is NOT affected by filter
- [ ] .NET searches use config setting instead of hardcoded -preview
</success_criteria>

<output>
After completion, create `.planning/phases/11-windows-update-filtering/11-02-SUMMARY.md`
</output>
