---
phase: 11-windows-update-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/config/ffubuilder-config.schema.json
  - FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1
  - FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1
autonomous: true
user_setup: []

must_haves:
  truths:
    - "New configs include IncludePreviewUpdates property with false default"
    - "Existing configs without IncludePreviewUpdates get migrated with false default"
    - "Config validation accepts IncludePreviewUpdates boolean"
  artifacts:
    - path: "FFUDevelopment/config/ffubuilder-config.schema.json"
      provides: "IncludePreviewUpdates schema definition"
      contains: "IncludePreviewUpdates"
    - path: "FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1"
      provides: "Migration logic for new property"
      contains: "IncludePreviewUpdates"
  key_links:
    - from: "FFU.ConfigMigration.psm1"
      to: "schema.json"
      via: "schema version bump to 1.1"
      pattern: "1\\.1"
---

<objective>
Add IncludePreviewUpdates configuration property with schema validation and migration support.

Purpose: Establish the foundational config property that enables preview update filtering. This property must exist before UI and build logic can reference it.

Output: Config schema with new boolean property (default: false) and migration handling for existing configs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-windows-update-filtering/11-RESEARCH.md

# Existing patterns to follow
@FFUDevelopment/config/ffubuilder-config.schema.json
@FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IncludePreviewUpdates to config schema</name>
  <files>FFUDevelopment/config/ffubuilder-config.schema.json</files>
  <action>
Add the IncludePreviewUpdates property to the JSON schema. Insert after the existing UpdatePreviewCU property (around line 410) for logical grouping with other update-related settings.

Property definition:
```json
"IncludePreviewUpdates": {
    "type": "boolean",
    "default": false,
    "description": "When set to true, allows preview/optional updates in Windows Update searches. When false (default), search queries exclude preview updates to ensure only GA (Generally Available) releases are downloaded. Affects Cumulative Updates and .NET Framework updates."
}
```

Do NOT modify the configSchemaVersion property in this task - that happens in Task 2.
  </action>
  <verify>
Validate JSON syntax:
```powershell
$schema = Get-Content "FFUDevelopment/config/ffubuilder-config.schema.json" -Raw | ConvertFrom-Json
$schema.properties.IncludePreviewUpdates.type -eq 'boolean'
$schema.properties.IncludePreviewUpdates.default -eq $false
```
  </verify>
  <done>Schema contains IncludePreviewUpdates boolean property with false default and descriptive text</done>
</task>

<task type="auto">
  <name>Task 2: Add config migration for IncludePreviewUpdates</name>
  <files>
    FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1
    FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1
  </files>
  <action>
1. In FFU.ConfigMigration.psm1:
   - Update $script:CurrentConfigSchemaVersion from "1.0" to "1.1" (line 27)
   - Add migration region after line 436 (after CopyOfficeConfigXML region) to handle missing IncludePreviewUpdates:

```powershell
#region Migration: Add IncludePreviewUpdates default (v1.1)
if (-not $migrated.ContainsKey('IncludePreviewUpdates')) {
    $migrated['IncludePreviewUpdates'] = $false
    $changes += "Added default 'IncludePreviewUpdates=false' (preview updates excluded by default)"
}
#endregion
```

2. In FFU.ConfigMigration.psd1:
   - Bump ModuleVersion from current to next patch (e.g., 1.0.0 -> 1.0.1)
   - Add release note: "Added migration support for IncludePreviewUpdates property (v1.1 schema)"

Note: The migration adds the default value ONLY if the property is missing - existing configs that explicitly set it are preserved.
  </action>
  <verify>
Test migration logic:
```powershell
Import-Module "FFUDevelopment/Modules/FFU.ConfigMigration" -Force
Get-FFUConfigSchemaVersion  # Should return "1.1"

# Test migration of old config without the property
$oldConfig = @{ VMName = "Test"; configSchemaVersion = "1.0" }
$result = Invoke-FFUConfigMigration -Config $oldConfig
$result.Config.IncludePreviewUpdates -eq $false  # Should be true
$result.Changes -contains "Added default 'IncludePreviewUpdates=false' (preview updates excluded by default)"
```
  </verify>
  <done>
Migration module at version 1.1 with IncludePreviewUpdates defaulting to false for configs missing the property
  </done>
</task>

</tasks>

<verification>
1. Schema validation passes:
```powershell
$schema = Get-Content "FFUDevelopment/config/ffubuilder-config.schema.json" -Raw | ConvertFrom-Json
$schema.properties.IncludePreviewUpdates | Should -Not -BeNullOrEmpty
```

2. Migration works for old configs:
```powershell
Import-Module "FFUDevelopment/Modules/FFU.ConfigMigration" -Force
$oldConfig = @{ configSchemaVersion = "1.0" }
$result = Invoke-FFUConfigMigration -Config $oldConfig
$result.Config.configSchemaVersion | Should -Be "1.1"
$result.Config.IncludePreviewUpdates | Should -Be $false
```

3. Module imports cleanly:
```powershell
Import-Module "FFUDevelopment/Modules/FFU.ConfigMigration" -Force -ErrorAction Stop
```
</verification>

<success_criteria>
- [ ] ffubuilder-config.schema.json contains IncludePreviewUpdates property
- [ ] Property type is boolean with default false
- [ ] FFU.ConfigMigration version bumped to 1.1
- [ ] Migration adds IncludePreviewUpdates=false for configs without it
- [ ] Existing configs with IncludePreviewUpdates are not modified
- [ ] Module imports without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-windows-update-filtering/11-01-SUMMARY.md`
</output>
