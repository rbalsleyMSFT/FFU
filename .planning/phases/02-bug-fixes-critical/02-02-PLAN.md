---
phase: 02-bug-fixes-critical
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/FFU.Common/FFU.Common.Classes.psm1
  - FFUDevelopment/FFU.Common/FFU.Common.psd1
autonomous: true

must_haves:
  truths:
    - "Proxy settings are detected from environment variables, registry, and WinHTTP"
    - "SSL inspection proxies (Netskope, zScaler) are detected by certificate issuer"
    - "User receives clear warning when SSL inspection is detected"
    - "Downloads work through corporate proxies with proper configuration"
  artifacts:
    - path: "FFUDevelopment/FFU.Common/FFU.Common.Classes.psm1"
      provides: "Enhanced FFUNetworkConfiguration with SSL detection"
      contains: "Test-SSLInspection"
    - path: "FFUDevelopment/FFU.Common/FFU.Common.psd1"
      provides: "Updated module manifest"
      contains: "BUG-01"
  key_links:
    - from: "FFUNetworkConfiguration::DetectProxySettings"
      to: "Test-SSLInspection method"
      via: "SSL certificate issuer check"
      pattern: "Netskope|Zscaler|goskope"
---

<objective>
Fix corporate proxy failures with SSL inspection (BUG-01)

Purpose: Corporate environments using Netskope, zScaler, or similar SSL-inspecting proxies cause driver and update downloads to fail. The existing FFUNetworkConfiguration class detects proxy settings but doesn't handle SSL inspection scenarios.

Output: Enhanced FFUNetworkConfiguration class with:
1. SSL inspection detection via certificate issuer checking
2. Clear warning messages when SSL inspection is detected
3. Remediation guidance for users
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bug-fixes-critical/02-RESEARCH.md

@FFUDevelopment/FFU.Common/FFU.Common.Classes.psm1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSL inspection detection to FFUNetworkConfiguration</name>
  <files>FFUDevelopment/FFU.Common/FFU.Common.Classes.psm1</files>
  <action>
Add the following to the FFUNetworkConfiguration class in FFU.Common.Classes.psm1:

1. Add new properties to the class:
```powershell
[bool]$SSLInspectionDetected
[string]$SSLInspectorType
[string]$CertificateIssuer
```

2. Add a new static method `Test-SSLInspection` that:
   - Takes a test URL (default: https://www.microsoft.com)
   - Creates an HttpWebRequest with HEAD method
   - Gets the response certificate issuer
   - Checks against known SSL inspectors: Netskope, Zscaler, goskope, Blue Coat, Forcepoint
   - Returns detection result

3. Modify the existing `DetectProxySettings()` static method to call `Test-SSLInspection` when a proxy is detected

4. Add remediation guidance logging when SSL inspection is detected:
   - Log the inspector type
   - Suggest adding exclusions for Microsoft download domains
   - Suggest importing proxy root certificate if not in store

The method signature:
```powershell
static [PSCustomObject] TestSSLInspection([string]$TestUrl = "https://www.microsoft.com", [int]$TimeoutMs = 5000) {
    try {
        $request = [System.Net.HttpWebRequest]::Create($TestUrl)
        $request.Method = "HEAD"
        $request.Timeout = $TimeoutMs

        $response = $request.GetResponse()
        $cert = $request.ServicePoint.Certificate
        $response.Close()

        if ($null -eq $cert) {
            return [PSCustomObject]@{
                IsSSLInspected = $false
                Error = "No certificate returned"
            }
        }

        $issuer = $cert.Issuer
        $knownProxies = @('Netskope', 'Zscaler', 'goskope', 'Blue Coat', 'Forcepoint', 'McAfee', 'Symantec')

        foreach ($proxy in $knownProxies) {
            if ($issuer -match $proxy) {
                return [PSCustomObject]@{
                    IsSSLInspected = $true
                    ProxyType = $proxy
                    Issuer = $issuer
                }
            }
        }

        return [PSCustomObject]@{ IsSSLInspected = $false; Issuer = $issuer }
    }
    catch {
        return [PSCustomObject]@{
            IsSSLInspected = $false
            Error = $_.Exception.Message
        }
    }
}
```

5. Update DetectProxySettings to use it:
```powershell
# After detecting proxy server, test for SSL inspection
if ($config.ProxyServer) {
    $sslCheck = [FFUNetworkConfiguration]::TestSSLInspection()
    if ($sslCheck.IsSSLInspected) {
        $config.SSLInspectionDetected = $true
        $config.SSLInspectorType = $sslCheck.ProxyType
        $config.CertificateIssuer = $sslCheck.Issuer
        WriteLog "WARNING: SSL inspection detected ($($sslCheck.ProxyType))"
        WriteLog "WARNING: If downloads fail with certificate errors, ensure the proxy root certificate is in the Windows certificate store"
        WriteLog "WARNING: Consider adding exclusions for: *.microsoft.com, *.windowsupdate.com, *.dell.com, *.hp.com, *.lenovo.com"
    }
}
```
  </action>
  <verify>
1. Load module: `Import-Module FFUDevelopment/FFU.Common/FFU.Common.psd1 -Force`
2. Verify method exists: `[FFUNetworkConfiguration]::TestSSLInspection.OverloadDefinitions` should show the method
3. Verify new properties: `[FFUNetworkConfiguration]::new() | Get-Member -Name SSLInspectionDetected` should return the property
  </verify>
  <done>FFUNetworkConfiguration has TestSSLInspection method and three new SSL-related properties</done>
</task>

<task type="auto">
  <name>Task 2: Update module manifest</name>
  <files>FFUDevelopment/FFU.Common/FFU.Common.psd1</files>
  <action>
Update FFU.Common module manifest:

1. Increment ModuleVersion (e.g., from current to next patch)
2. Add release notes: "BUG-01: Added SSL inspection detection for Netskope/zScaler proxies in FFUNetworkConfiguration"

This documents the enhancement for corporate proxy support.
  </action>
  <verify>
1. Verify manifest: `Test-ModuleManifest FFUDevelopment/FFU.Common/FFU.Common.psd1`
2. Check version incremented
3. Check release notes contain BUG-01
  </verify>
  <done>FFU.Common module version incremented with release notes documenting BUG-01 fix</done>
</task>

</tasks>

<verification>
1. Module loads: `Import-Module FFUDevelopment/FFU.Common -Force`
2. New method callable: `[FFUNetworkConfiguration]::TestSSLInspection()` returns PSCustomObject
3. DetectProxySettings includes SSL check: Review code shows SSL inspection call
4. Manifest valid: `Test-ModuleManifest FFUDevelopment/FFU.Common/FFU.Common.psd1`
</verification>

<success_criteria>
- FFUNetworkConfiguration class has SSLInspectionDetected, SSLInspectorType, CertificateIssuer properties
- TestSSLInspection static method exists and detects known SSL inspectors
- DetectProxySettings calls TestSSLInspection when proxy detected
- Clear warning messages are logged when SSL inspection is detected
- Module manifest updated with version increment and release notes
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes-critical/02-02-SUMMARY.md`
</output>
