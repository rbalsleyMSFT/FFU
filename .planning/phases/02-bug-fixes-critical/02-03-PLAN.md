---
phase: 02-bug-fixes-critical
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1
  - FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1
autonomous: true

must_haves:
  truths:
    - "OS partition auto-expands when driver set exceeds 5GB"
    - "VHDX file is properly dismounted before resize"
    - "Partition is expanded to fill new VHDX space after resize"
    - "Build succeeds with large driver sets that previously failed"
  artifacts:
    - path: "FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1"
      provides: "Expand-FFUPartitionForDrivers function"
      exports: ["Expand-FFUPartitionForDrivers"]
      min_lines: 80
    - path: "FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1"
      provides: "Updated module manifest"
      contains: "BUG-03"
  key_links:
    - from: "Expand-FFUPartitionForDrivers"
      to: "Resize-VHD cmdlet"
      via: "VHDX expansion"
      pattern: "Resize-VHD"
    - from: "Expand-FFUPartitionForDrivers"
      to: "Resize-Partition cmdlet"
      via: "Partition expansion"
      pattern: "Resize-Partition"
---

<objective>
Fix OS partition expansion for large driver sets (BUG-03)

Purpose: When driver sets exceed 5GB, the default VHDX size may not have enough free space for driver injection. This causes "insufficient space" errors during DISM Add-WindowsDriver operations. Issue #298.

Output: New Expand-FFUPartitionForDrivers function that:
1. Calculates driver folder size
2. Expands VHDX file if needed
3. Expands OS partition to fill new space
4. Handles mount/dismount safely
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bug-fixes-critical/02-RESEARCH.md

@FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1 (note: large file, focus on Export-ModuleMember section)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Expand-FFUPartitionForDrivers function</name>
  <files>FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1</files>
  <action>
Add a new function `Expand-FFUPartitionForDrivers` to FFU.Imaging.psm1. Place it before the Export-ModuleMember statement.

```powershell
function Expand-FFUPartitionForDrivers {
    <#
    .SYNOPSIS
    Expands VHDX and OS partition to accommodate large driver sets

    .DESCRIPTION
    Calculates driver folder size and expands the VHDX file and OS partition
    if the driver set exceeds the specified threshold. Addresses Issue #298.

    .PARAMETER VHDXPath
    Path to the VHDX file to expand

    .PARAMETER DriversFolder
    Path to the drivers folder to measure

    .PARAMETER ThresholdGB
    Minimum driver size (GB) that triggers expansion (default: 5)

    .PARAMETER SafetyMarginGB
    Additional space to add beyond driver size (default: 5)

    .EXAMPLE
    Expand-FFUPartitionForDrivers -VHDXPath "C:\FFU\VM.vhdx" -DriversFolder "C:\FFU\Drivers\Dell"
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]$VHDXPath,

        [Parameter(Mandatory = $true)]
        [string]$DriversFolder,

        [Parameter()]
        [int]$ThresholdGB = 5,

        [Parameter()]
        [int]$SafetyMarginGB = 5
    )

    # Validate inputs
    if (-not (Test-Path -Path $VHDXPath)) {
        WriteLog "ERROR: VHDX file not found: $VHDXPath"
        throw "VHDX file not found: $VHDXPath"
    }

    if (-not (Test-Path -Path $DriversFolder)) {
        WriteLog "WARNING: Drivers folder not found: $DriversFolder - skipping expansion check"
        return
    }

    # Calculate driver folder size
    $driverBytes = (Get-ChildItem -Path $DriversFolder -Recurse -File -ErrorAction SilentlyContinue |
                    Measure-Object -Property Length -Sum).Sum

    if ($null -eq $driverBytes) { $driverBytes = 0 }

    $driverSizeGB = [math]::Ceiling($driverBytes / 1GB)
    WriteLog "Driver folder size: ${driverSizeGB}GB ($([math]::Round($driverBytes / 1MB, 2)) MB)"

    # Check threshold
    if ($driverSizeGB -lt $ThresholdGB) {
        WriteLog "Driver set (${driverSizeGB}GB) is under threshold (${ThresholdGB}GB) - no expansion needed"
        return
    }

    WriteLog "Driver set (${driverSizeGB}GB) exceeds threshold (${ThresholdGB}GB) - checking VHDX capacity"

    # Get current VHDX info
    $vhdx = Get-VHD -Path $VHDXPath -ErrorAction Stop
    $currentSizeGB = [math]::Floor($vhdx.Size / 1GB)
    $wasMounted = $vhdx.Attached

    WriteLog "Current VHDX size: ${currentSizeGB}GB, Attached: $wasMounted"

    # Calculate required size with safety margin and 1.5x factor for DISM compression overhead
    $compressionFactor = 1.5
    $requiredDriverSpace = [math]::Ceiling($driverSizeGB * $compressionFactor)
    $requiredSizeGB = $currentSizeGB + $requiredDriverSpace + $SafetyMarginGB
    WriteLog "Required VHDX size: ${requiredSizeGB}GB (driver: ${driverSizeGB}GB x $compressionFactor + margin: ${SafetyMarginGB}GB)"

    # Dismount if mounted - Resize-VHD requires exclusive access
    if ($wasMounted) {
        WriteLog "Dismounting VHDX for resize operation..."
        Dismount-VHD -Path $VHDXPath -ErrorAction Stop
        # Wait for file lock release
        Start-Sleep -Seconds 2
        WriteLog "VHDX dismounted"
    }

    try {
        # Resize VHDX
        WriteLog "Expanding VHDX from ${currentSizeGB}GB to ${requiredSizeGB}GB..."
        Resize-VHD -Path $VHDXPath -SizeBytes ($requiredSizeGB * 1GB) -ErrorAction Stop
        WriteLog "VHDX expanded successfully"

        # Mount and expand partition
        WriteLog "Mounting VHDX to expand partition..."
        $disk = Mount-VHD -Path $VHDXPath -Passthru -ErrorAction Stop | Get-Disk
        WriteLog "VHDX mounted as Disk $($disk.Number)"

        # Find the OS partition (largest Basic partition with drive letter)
        $osPartition = Get-Partition -DiskNumber $disk.Number -ErrorAction Stop |
                       Where-Object { $_.Type -eq 'Basic' -and $_.DriveLetter } |
                       Sort-Object Size -Descending |
                       Select-Object -First 1

        if (-not $osPartition) {
            WriteLog "WARNING: Could not identify OS partition - looking for largest Basic partition"
            $osPartition = Get-Partition -DiskNumber $disk.Number -ErrorAction Stop |
                           Where-Object { $_.Type -eq 'Basic' } |
                           Sort-Object Size -Descending |
                           Select-Object -First 1
        }

        if ($osPartition) {
            $currentPartitionGB = [math]::Floor($osPartition.Size / 1GB)
            WriteLog "Found OS partition: $($osPartition.PartitionNumber) at $($osPartition.DriveLetter): (${currentPartitionGB}GB)"

            # Get maximum supported size
            $supportedSize = Get-PartitionSupportedSize -DiskNumber $disk.Number -PartitionNumber $osPartition.PartitionNumber
            $maxSizeGB = [math]::Floor($supportedSize.SizeMax / 1GB)
            WriteLog "Maximum supported partition size: ${maxSizeGB}GB"

            if ($supportedSize.SizeMax -gt $osPartition.Size) {
                WriteLog "Expanding partition to maximum supported size..."
                Resize-Partition -DiskNumber $disk.Number -PartitionNumber $osPartition.PartitionNumber -Size $supportedSize.SizeMax -ErrorAction Stop
                $newPartitionGB = [math]::Floor((Get-Partition -DiskNumber $disk.Number -PartitionNumber $osPartition.PartitionNumber).Size / 1GB)
                WriteLog "Partition expanded from ${currentPartitionGB}GB to ${newPartitionGB}GB"
            }
            else {
                WriteLog "Partition is already at maximum size"
            }
        }
        else {
            WriteLog "WARNING: Could not find OS partition to expand"
        }

        # Dismount if it wasn't mounted before
        if (-not $wasMounted) {
            WriteLog "Dismounting VHDX (was not mounted before expansion)..."
            Dismount-VHD -Path $VHDXPath -ErrorAction Stop
            WriteLog "VHDX dismounted"
        }
    }
    catch {
        WriteLog "ERROR: Partition expansion failed: $($_.Exception.Message)"

        # Attempt to restore mount state
        if ($wasMounted) {
            WriteLog "Attempting to remount VHDX..."
            Mount-VHD -Path $VHDXPath -ErrorAction SilentlyContinue
        }

        throw $_
    }

    WriteLog "VHDX expansion complete - ready for driver injection"
}
```

Also add the function to the Export-ModuleMember list at the end of the file.
  </action>
  <verify>
1. Load module: `Import-Module FFUDevelopment/Modules/FFU.Imaging -Force`
2. Verify function exists: `Get-Command Expand-FFUPartitionForDrivers` returns the function
3. Verify help: `Get-Help Expand-FFUPartitionForDrivers` shows the synopsis and parameters
  </verify>
  <done>Expand-FFUPartitionForDrivers function exists and is exported from FFU.Imaging module</done>
</task>

<task type="auto">
  <name>Task 2: Update FFU.Imaging module manifest</name>
  <files>FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1</files>
  <action>
Update the FFU.Imaging module manifest:

1. Increment ModuleVersion (e.g., from 1.0.1 to 1.0.2)
2. Add 'Expand-FFUPartitionForDrivers' to FunctionsToExport array
3. Add release notes: "BUG-03: Added Expand-FFUPartitionForDrivers for automatic VHDX/partition expansion with large driver sets"
  </action>
  <verify>
1. Test manifest: `Test-ModuleManifest FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1`
2. Verify version incremented
3. Verify function in exports: Check FunctionsToExport contains Expand-FFUPartitionForDrivers
  </verify>
  <done>FFU.Imaging module manifest updated with new function export and release notes</done>
</task>

</tasks>

<verification>
1. Module loads: `Import-Module FFUDevelopment/Modules/FFU.Imaging -Force`
2. Function exported: `Get-Command -Module FFU.Imaging | Where-Object Name -eq 'Expand-FFUPartitionForDrivers'`
3. Manifest valid: `Test-ModuleManifest FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psd1`
4. Code patterns present:
   - `Select-String -Path FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1 -Pattern "Resize-VHD"`
   - `Select-String -Path FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1 -Pattern "Get-PartitionSupportedSize"`
</verification>

<success_criteria>
- Expand-FFUPartitionForDrivers function exists with proper CmdletBinding
- Function calculates driver folder size correctly
- Function expands VHDX when driver set exceeds threshold (default 5GB)
- Function uses Get-PartitionSupportedSize before Resize-Partition
- Function properly dismounts VHDX before resize and remounts after
- Module manifest updated with version increment and release notes
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes-critical/02-03-SUMMARY.md`
</output>
