---
phase: 02-bug-fixes-critical
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psm1
  - FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psd1
  - FFUDevelopment/Modules/FFU.Constants/FFU.Constants.psm1
autonomous: true

must_haves:
  truths:
    - "Dell chipset driver extraction completes within timeout instead of hanging indefinitely"
    - "Child processes spawned by Dell driver installers are properly terminated"
    - "Build continues normally after chipset driver extraction"
  artifacts:
    - path: "FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psm1"
      provides: "Enhanced Get-DellDrivers with process timeout"
      contains: "WaitForExit"
    - path: "FFUDevelopment/Modules/FFU.Constants/FFU.Constants.psm1"
      provides: "DRIVER_EXTRACTION_TIMEOUT_SECONDS constant"
      contains: "DRIVER_EXTRACTION_TIMEOUT_SECONDS"
  key_links:
    - from: "Get-DellDrivers"
      to: "Start-Process + WaitForExit"
      via: "Timeout-based extraction"
      pattern: "WaitForExit.*\\d+"
---

<objective>
Fix Dell chipset driver extraction hang (BUG-04)

Purpose: Dell Intel chipset driver installers can spawn GUI windows that hang indefinitely even with /s silent switch. This causes builds to halt during driver extraction. The current implementation uses Start-Sleep with hardcoded waits but doesn't properly detect and kill hung processes.

Output: Enhanced Get-DellDrivers function that uses proper process timeout with WaitForExit() method, detects hung processes via timeout, and kills parent + child processes cleanly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bug-fixes-critical/02-RESEARCH.md

@FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psm1
@FFUDevelopment/Modules/FFU.Constants/FFU.Constants.psm1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout constant to FFU.Constants</name>
  <files>FFUDevelopment/Modules/FFU.Constants/FFU.Constants.psm1</files>
  <action>
Add a new constant for driver extraction timeout:
- `static [int] $DRIVER_EXTRACTION_TIMEOUT_SECONDS = 30` - Timeout for Dell/Intel driver extraction processes

Place this constant in the "Timeouts" section of the FFUConstants class, near existing timeout constants like PROCESS_CLEANUP_TIMEOUT.

This value is calibrated for driver extraction which typically completes in 5-15 seconds, with 30 seconds as a generous safety margin.
  </action>
  <verify>
1. Load module: `Import-Module FFUDevelopment/Modules/FFU.Constants/FFU.Constants.psm1 -Force`
2. Verify constant: `[FFUConstants]::DRIVER_EXTRACTION_TIMEOUT_SECONDS` returns 30
  </verify>
  <done>DRIVER_EXTRACTION_TIMEOUT_SECONDS constant exists in FFU.Constants and returns 30</done>
</task>

<task type="auto">
  <name>Task 2: Enhance Dell chipset driver extraction with timeout</name>
  <files>FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psm1</files>
  <action>
Refactor the Chipset and Network driver extraction sections in Get-DellDrivers (around lines 1302-1340) to use proper timeout-based process handling:

Replace the current pattern:
```powershell
$process = Invoke-Process -FilePath $driverFilePath -ArgumentList $arguments -Wait $false
Start-Sleep -Seconds ([FFUConstants]::DRIVER_EXTRACTION_WAIT)
$childProcesses = Get-ChildProcesses $process.Id
```

With timeout-based extraction:
```powershell
WriteLog "Extracting Chipset driver with timeout protection: $driverFilePath"
$process = Start-Process -FilePath $driverFilePath -ArgumentList $arguments -PassThru -NoNewWindow

# Wait with timeout
$timeoutSeconds = [FFUConstants]::DRIVER_EXTRACTION_TIMEOUT_SECONDS
$completed = $process.WaitForExit($timeoutSeconds * 1000)

if (-not $completed) {
    WriteLog "WARNING: Chipset driver extraction timed out after ${timeoutSeconds}s - killing process tree"

    # Kill child processes first (Intel GUI windows)
    $childProcesses = Get-CimInstance Win32_Process -Filter "ParentProcessId = $($process.Id)" -ErrorAction SilentlyContinue
    foreach ($child in $childProcesses) {
        WriteLog "Stopping child process: $($child.Name) (PID: $($child.ProcessId))"
        Stop-Process -Id $child.ProcessId -Force -ErrorAction SilentlyContinue
    }

    # Kill parent process
    Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
    Start-Sleep -Seconds 1  # Allow cleanup
}
else {
    WriteLog "Chipset driver extraction completed with exit code: $($process.ExitCode)"
}
```

Apply the same pattern to the Network driver section (elseif $driver.Category -eq "Network" block).

Key changes:
1. Use Start-Process directly with -PassThru (not Invoke-Process)
2. Use .WaitForExit(timeout) method for proper timeout
3. Use Get-CimInstance instead of Get-ChildProcesses (more reliable)
4. Kill child processes BEFORE parent
5. Log what's happening at each step
  </action>
  <verify>
1. Load module: `Import-Module FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psm1 -Force`
2. Verify function syntax: `Get-Command Get-DellDrivers` returns without error
3. Grep for pattern: Search for "WaitForExit" in FFU.Drivers.psm1 - should find the timeout pattern
  </verify>
  <done>Get-DellDrivers uses WaitForExit with timeout for Chipset and Network drivers, with proper process tree termination</done>
</task>

<task type="auto">
  <name>Task 3: Update module manifest version</name>
  <files>FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psd1</files>
  <action>
Increment the FFU.Drivers module version and add release notes:

1. Increment ModuleVersion (e.g., from 1.0.2 to 1.0.3)
2. Add release notes: "BUG-04: Fixed Dell chipset driver extraction hang - added timeout-based process handling"

Also update FFU.Constants version if a constant was added.
  </action>
  <verify>
1. Read FFU.Drivers.psd1 and verify ModuleVersion is incremented
2. Verify ReleaseNotes contains BUG-04 reference
  </verify>
  <done>FFU.Drivers module version incremented with release notes documenting BUG-04 fix</done>
</task>

</tasks>

<verification>
1. Module loads without errors: `Import-Module FFUDevelopment/Modules/FFU.Drivers -Force`
2. Timeout constant accessible: `[FFUConstants]::DRIVER_EXTRACTION_TIMEOUT_SECONDS -eq 30`
3. Code contains timeout pattern: `Select-String -Path FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psm1 -Pattern "WaitForExit"`
4. No PowerShell syntax errors: `Test-ModuleManifest FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psd1`
</verification>

<success_criteria>
- Dell chipset driver extraction uses proper timeout (30 seconds by default)
- Hung processes are detected and terminated cleanly
- Child processes are killed before parent process
- Module version incremented with release notes
- All existing driver extraction functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes-critical/02-01-SUMMARY.md`
</output>
