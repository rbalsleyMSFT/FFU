---
phase: 06-integration-tests-ui-error
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Tests/Unit/FFUUI.Core.Handlers.Tests.ps1
autonomous: true

must_haves:
  truths:
    - "Integer-only validation logic rejects non-digits"
    - "Thread count validation resets invalid values to 1"
    - "USB drive count validation resets invalid values to 0"
    - "UI visibility logic works correctly"
  artifacts:
    - path: "Tests/Unit/FFUUI.Core.Handlers.Tests.ps1"
      provides: "UI handler business logic tests"
      min_lines: 150
  key_links:
    - from: "Tests/Unit/FFUUI.Core.Handlers.Tests.ps1"
      to: "FFUUI.Core.Handlers.psm1"
      via: "Logic extraction pattern"
      pattern: "\\-match '\\\\D'"
---

<objective>
Create unit tests for FFUUI.Core.Handlers.psm1 key functions using mock State objects.

Purpose: TEST-04 requires unit test coverage for UI event handlers. Since WPF types are unavailable in test context, tests focus on the PowerShell business logic within handlers (validation, visibility toggling, state management).

Output: Tests/Unit/FFUUI.Core.Handlers.Tests.ps1 with 15+ tests covering validation and state management logic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-integration-tests-ui-error/06-RESEARCH.md

# Source files to test
@FFUDevelopment/FFUUI.Core/FFUUI.Core.Handlers.psm1

# Test patterns from prior phases
@Tests/Unit/FFU.Hypervisor.Tests.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FFUUI.Core.Handlers unit tests</name>
  <files>Tests/Unit/FFUUI.Core.Handlers.Tests.ps1</files>
  <action>
Create Pester 5.x test file with the following structure:

**BeforeAll block:**
- Define mock State object structure matching FFUUI.Core.Handlers expectations:
  - Controls hash with txtThreads, txtMaxUSBDrives, usbSection, chkSelectSpecificUSBDrives, lstUSBDrives, txtFFUDevPath, chkInstallDrivers, lstDriverModels
  - Each control as PSCustomObject with Text, IsChecked, IsEnabled, Visibility, Items properties as appropriate
  - Data hash with allDriverModels list, vmSwitchMap hash
  - Flags hash with lastSortProperty, lastSortAscending
  - FFUDevelopmentPath string

**Test Contexts (extract logic from Register-EventHandlers):**

1. **Integer-Only TextBox Validation:**
   - Test that regex `\D` matches non-digit characters
   - Test that regex `\D` does not match valid integers
   - Test that paste validation accepts `^\d+$` patterns
   - Test that paste validation rejects mixed alphanumeric

2. **Thread Count Validation (txtThreads.LostFocus logic):**
   - Test that empty text resets to '1'
   - Test that '0' resets to '1'
   - Test that negative value resets to '1'
   - Test that valid positive integer is preserved
   - Test that non-numeric text resets to '1'

3. **Max USB Drives Validation (txtMaxUSBDrives.LostFocus logic):**
   - Test that empty text resets to '0'
   - Test that negative value resets to '0'
   - Test that '0' is accepted (means "all drives")
   - Test that valid positive integer is preserved

4. **USB Settings Visibility Logic:**
   - Test that enabling USB drive shows usbSection
   - Test that enabling USB drive enables chkSelectSpecificUSBDrives
   - Test that disabling USB drive hides usbSection
   - Test that disabling USB drive clears lstUSBDrives items

**Tags:** Include `-Tag 'Unit', 'FFUUI.Core', 'Handlers', 'TEST-04'`

**Important:** Do NOT import FFUUI.Core module (requires WPF). Test extracted logic patterns directly.
  </action>
  <verify>
Run tests with:
```powershell
Invoke-Pester -Path "Tests/Unit/FFUUI.Core.Handlers.Tests.ps1" -Output Detailed
```
All tests should pass.
  </verify>
  <done>
15+ tests exist in FFUUI.Core.Handlers.Tests.ps1 covering:
- Integer validation regex patterns (4 tests)
- Thread count validation (5 tests)
- Max USB drives validation (4 tests)
- USB settings visibility logic (4 tests)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify test coverage and tag structure</name>
  <files>Tests/Unit/FFUUI.Core.Handlers.Tests.ps1</files>
  <action>
Run tests to verify:
1. All tests pass
2. Tests are properly tagged for selective execution
3. No WPF dependencies are required

Execute:
```powershell
# Run all tests
Invoke-Pester -Path "Tests/Unit/FFUUI.Core.Handlers.Tests.ps1" -Output Detailed

# Verify tag filtering works
Invoke-Pester -Path "Tests/Unit/FFUUI.Core.Handlers.Tests.ps1" -Tag 'TEST-04' -Output Detailed
```

If any tests fail, fix the test logic to match actual handler behavior in FFUUI.Core.Handlers.psm1.
  </action>
  <verify>
All tests pass and can be filtered by TEST-04 tag.
  </verify>
  <done>
Tests run successfully without WPF runtime, tagged for TEST-04 requirement tracing.
  </done>
</task>

</tasks>

<verification>
1. Test file exists at Tests/Unit/FFUUI.Core.Handlers.Tests.ps1
2. All tests pass when run with Invoke-Pester
3. Tests can be filtered by -Tag 'TEST-04'
4. No WPF assemblies required to run tests
</verification>

<success_criteria>
- 15+ unit tests for UI handler business logic
- Tests validate input filtering, range validation, visibility toggling
- No WPF dependencies (tests run in any PowerShell context)
- TEST-04 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-tests-ui-error/06-01-SUMMARY.md`
</output>
