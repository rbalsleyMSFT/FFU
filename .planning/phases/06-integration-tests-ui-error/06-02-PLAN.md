---
phase: 06-integration-tests-ui-error
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Tests/Unit/FFU.Core.Cleanup.Tests.ps1
autonomous: true

must_haves:
  truths:
    - "Register-CleanupAction returns valid GUID and stores entry"
    - "Unregister-CleanupAction removes entry from registry"
    - "Invoke-FailureCleanup executes actions in LIFO order"
    - "Cleanup continues even when individual actions fail"
    - "Specialized cleanup functions register correct resource types"
  artifacts:
    - path: "Tests/Unit/FFU.Core.Cleanup.Tests.ps1"
      provides: "Cleanup registry system tests"
      min_lines: 200
  key_links:
    - from: "Tests/Unit/FFU.Core.Cleanup.Tests.ps1"
      to: "FFU.Core.psm1"
      via: "InModuleScope for CleanupRegistry access"
      pattern: "InModuleScope.*CleanupRegistry"
---

<objective>
Create unit tests for FFU.Core cleanup registry system (error recovery paths).

Purpose: TEST-05 requires tests for error recovery paths and cleanup handlers. The FFU.Core module contains a cleanup registry system (Register-CleanupAction, Unregister-CleanupAction, Invoke-FailureCleanup) and specialized cleanup functions that need test coverage.

Output: Tests/Unit/FFU.Core.Cleanup.Tests.ps1 with 25+ tests covering cleanup registration, unregistration, execution order, and specialized cleanup functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-integration-tests-ui-error/06-RESEARCH.md

# Source code for cleanup system
@FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1 (lines 2162-2600)

# Existing test patterns
@Tests/Unit/FFU.Core.Tests.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cleanup registry system tests</name>
  <files>Tests/Unit/FFU.Core.Cleanup.Tests.ps1</files>
  <action>
Create Pester 5.x test file with the following structure:

**BeforeAll block:**
- Get paths to FFUDevelopment/Modules
- Add modules folder to PSModulePath
- Import FFU.Core module
- Mock WriteLog to suppress logging noise

**BeforeEach block:**
- Reset cleanup registry between tests using InModuleScope:
  ```powershell
  InModuleScope 'FFU.Core' {
      $script:CleanupRegistry.Clear()
  }
  ```

**Test Contexts:**

1. **Register-CleanupAction:**
   - Returns valid GUID format (matches regex `^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$`)
   - Accepts all valid ResourceTypes: VM, VHDX, DISM, ISO, TempFile, BITS, Share, User, Other
   - Stores ResourceId when provided
   - Increments registry count after registration
   - Stores Action scriptblock correctly

2. **Unregister-CleanupAction:**
   - Returns $true when entry exists and is removed
   - Returns $false for non-existent ID
   - Returns $false when called twice with same ID
   - Decrements registry count after removal

3. **Invoke-FailureCleanup:**
   - Executes all registered actions
   - Executes in LIFO order (last registered first)
   - Continues after cleanup action throws exception
   - Filters by ResourceType when specified
   - Removes successful cleanups from registry
   - Keeps failed cleanups in registry

4. **Clear-CleanupRegistry:**
   - Removes all entries
   - Registry count is 0 after clear

5. **Get-CleanupRegistry:**
   - Returns array of registered entries
   - Returns empty array when no entries

**Tags:** Include `-Tag 'Unit', 'FFU.Core', 'Cleanup', 'TEST-05'`
  </action>
  <verify>
Run tests with:
```powershell
Invoke-Pester -Path "Tests/Unit/FFU.Core.Cleanup.Tests.ps1" -Output Detailed
```
All tests should pass.
  </verify>
  <done>
20+ tests covering core cleanup registry functions:
- Register-CleanupAction (5 tests)
- Unregister-CleanupAction (4 tests)
- Invoke-FailureCleanup (6 tests)
- Clear-CleanupRegistry (2 tests)
- Get-CleanupRegistry (2 tests)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add specialized cleanup function tests</name>
  <files>Tests/Unit/FFU.Core.Cleanup.Tests.ps1</files>
  <action>
Add tests for specialized cleanup registration functions to the same test file:

**Additional Test Contexts:**

6. **Register-VMCleanup:**
   - Registers with ResourceType 'VM'
   - Stores VMName as ResourceId
   - Returns valid GUID

7. **Register-VHDXCleanup:**
   - Registers with ResourceType 'VHDX'
   - Stores VHDXPath as ResourceId

8. **Register-DISMMountCleanup:**
   - Registers with ResourceType 'DISM'
   - Stores MountPath as ResourceId

9. **Register-ISOCleanup:**
   - Registers with ResourceType 'ISO'
   - Stores ISOPath as ResourceId

10. **Register-TempFileCleanup:**
    - Registers with ResourceType 'TempFile'
    - Stores Path as ResourceId
    - Handles -Recurse switch

11. **Register-NetworkShareCleanup:**
    - Registers with ResourceType 'Share'
    - Stores ShareName as ResourceId

12. **Register-UserAccountCleanup:**
    - Registers with ResourceType 'User'
    - Stores Username as ResourceId

13. **Register-SensitiveMediaCleanup:**
    - Registers with ResourceType 'TempFile'
    - Stores 'CaptureFFU-Backups' as ResourceId

**Verification:** Use InModuleScope to check CleanupRegistry entries have correct ResourceType and ResourceId after registration.
  </action>
  <verify>
Run tests with:
```powershell
Invoke-Pester -Path "Tests/Unit/FFU.Core.Cleanup.Tests.ps1" -Tag 'TEST-05' -Output Detailed
```
All tests should pass.
  </verify>
  <done>
8+ additional tests covering specialized cleanup functions:
- Register-VMCleanup (2 tests)
- Register-VHDXCleanup (2 tests)
- Register-DISMMountCleanup (1 test)
- Register-TempFileCleanup (2 tests)
- Register-NetworkShareCleanup (1 test)
- Register-UserAccountCleanup (1 test)
  </done>
</task>

</tasks>

<verification>
1. Test file exists at Tests/Unit/FFU.Core.Cleanup.Tests.ps1
2. All tests pass when run with Invoke-Pester
3. Tests can be filtered by -Tag 'TEST-05'
4. Cleanup registry is properly reset between tests
5. InModuleScope correctly accesses script-scoped variables
</verification>

<success_criteria>
- 25+ unit tests for cleanup registry system
- Tests verify LIFO execution order
- Tests verify error resilience (continues on cleanup failure)
- Tests verify specialized cleanup functions register correct types
- TEST-05 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-tests-ui-error/06-02-SUMMARY.md`
</output>
