---
phase: 06-integration-tests-ui-error
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1
autonomous: true

must_haves:
  truths:
    - "VMwareProvider validates VMDK configuration correctly"
    - "VMwareProvider rejects VHDX disk format"
    - "VMX generation creates valid settings"
    - "Diskpart functions exist for VMware disk operations"
  artifacts:
    - path: "Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1"
      provides: "VMware provider integration tests"
      min_lines: 150
  key_links:
    - from: "Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1"
      to: "FFU.Hypervisor/Providers/VMwareProvider.ps1"
      via: "Get-HypervisorProvider -Type 'VMware'"
      pattern: "Get-HypervisorProvider.*VMware"
---

<objective>
Create integration tests for VMware provider operations in FFU.Hypervisor module.

Purpose: TEST-06 requires tests for VMware provider operations. Tests verify configuration validation, VMX generation, and diskpart-based disk functions. Uses conditional skip pattern for tests requiring actual VMware installation.

Output: Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1 with 15+ tests covering VMware provider functionality
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-integration-tests-ui-error/06-RESEARCH.md

# VMware provider implementation
@FFUDevelopment/Modules/FFU.Hypervisor/Providers/VMwareProvider.ps1

# Existing Hypervisor tests (patterns)
@Tests/Unit/FFU.Hypervisor.Tests.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VMware provider integration tests</name>
  <files>Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1</files>
  <action>
Create Pester 5.x test file with the following structure:

**BeforeAll block:**
- Get paths to FFUDevelopment/Modules
- Add modules folder to PSModulePath
- Detect VMware installation:
  ```powershell
  $script:VMwareInstalled = $false
  $vmrunPath = "${env:ProgramFiles(x86)}\VMware\VMware Workstation\vmrun.exe"
  if (Test-Path $vmrunPath) {
      $script:VMwareInstalled = $true
  }
  ```
- Import FFU.Core (dependency) with -ErrorAction SilentlyContinue
- Import FFU.Hypervisor module
- Store module reference for InModuleScope

**Test Contexts:**

1. **VMwareProvider Availability:**
   - Get-HypervisorProvider returns VMware provider
   - Provider.Name equals 'VMware'
   - Provider.Capabilities contains expected properties

2. **VMware Configuration Validation:**
   - ValidateConfiguration accepts valid VMDK config
   - ValidateConfiguration rejects VHDX for VMware
   - ValidateConfiguration accepts memory within limits
   - ValidateConfiguration rejects memory above MaxMemoryGB
   - ValidateConfiguration rejects processors above MaxProcessors

3. **VMware Disk Format Support:**
   - Capabilities.SupportedDiskFormats contains 'VMDK'
   - Capabilities.SupportedDiskFormats contains 'VHD' (VMware 10+ feature)
   - Capabilities.SupportedDiskFormats does NOT contain 'VHDX'

4. **Diskpart Function Existence (for VMware disk ops):**
   - New-VHDWithDiskpart function exists in module
   - Mount-VHDWithDiskpart function exists in module
   - Dismount-VHDWithDiskpart function exists in module
   Use InModuleScope to verify these private functions exist.

5. **VMX File Generation (Skip if no VMware):**
   `-Skip:(-not $script:VMwareInstalled)`
   - New-VMwareVMX creates file at expected path
   - VMX contains correct memsize setting
   - VMX contains correct numvcpus setting
   - VMX contains guestOS setting
   Clean up test files in AfterEach.

**Tags:** Include `-Tag 'Integration', 'VMware', 'FFU.Hypervisor', 'TEST-06'`

**Important:** Use conditional skip pattern for tests that require actual VMware installation. Tests without skip should work on any machine.
  </action>
  <verify>
Run tests with:
```powershell
Invoke-Pester -Path "Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1" -Output Detailed
```
Tests should pass (some may be skipped if VMware not installed).
  </verify>
  <done>
15+ tests covering VMware provider:
- Provider availability (3 tests)
- Configuration validation (5 tests)
- Disk format support (3 tests)
- Diskpart function existence (3 tests)
- VMX generation (4 tests, conditional)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify test execution and skip behavior</name>
  <files>Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1</files>
  <action>
Run tests to verify:
1. All non-VMware-dependent tests pass
2. VMware-dependent tests skip gracefully when VMware not installed
3. Tests are properly tagged for selective execution

Execute:
```powershell
# Run all tests
Invoke-Pester -Path "Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1" -Output Detailed

# Verify tag filtering works
Invoke-Pester -Path "Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1" -Tag 'TEST-06' -Output Detailed
```

Verify test results show:
- Passed: Tests that don't require VMware
- Skipped: VMX generation tests (if VMware not installed)
- Failed: 0

If any tests fail unexpectedly, fix the test logic to match actual VMwareProvider implementation.
  </action>
  <verify>
Tests run successfully with appropriate skip behavior on machines without VMware.
  </verify>
  <done>
Tests execute correctly:
- Core provider tests pass on any machine
- VMware-specific tests skip gracefully when VMware not installed
- TEST-06 requirement satisfied
  </done>
</task>

</tasks>

<verification>
1. Test file exists at Tests/Integration/FFU.Hypervisor.VMware.Integration.Tests.ps1
2. All non-VMware-dependent tests pass
3. VMware-dependent tests use -Skip pattern correctly
4. Tests can be filtered by -Tag 'TEST-06'
5. No test failures on machines without VMware installed
</verification>

<success_criteria>
- 15+ integration tests for VMware provider
- Tests validate configuration, disk formats, and VMX generation
- Conditional skip pattern for VMware-dependent tests
- Tests pass on machines without VMware (with appropriate skips)
- TEST-06 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-tests-ui-error/06-03-SUMMARY.md`
</output>
