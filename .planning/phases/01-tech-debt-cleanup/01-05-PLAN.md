---
phase: 01-tech-debt-cleanup
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1
  - FFUDevelopment/Modules/FFU.VM/FFU.VM.psm1
  - FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1
  - FFUDevelopment/Modules/FFU.Media/FFU.Media.psm1
  - FFUDevelopment/Modules/FFU.Updates/FFU.Updates.psm1
  - FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psm1
  - FFUDevelopment/version.json
autonomous: true

must_haves:
  truths:
    - "SilentlyContinue reduced by 50%+ in production modules"
    - "Cleanup code still uses SilentlyContinue (appropriate)"
    - "Errors are logged where previously silenced"
    - "Build still succeeds end-to-end"
  artifacts:
    - path: "FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1"
      provides: "Core module with improved error handling"
    - path: "FFUDevelopment/Modules/FFU.VM/FFU.VM.psm1"
      provides: "VM module with improved error handling"
  key_links:
    - from: "All modified modules"
      to: "WriteLog"
      via: "Error logging"
      pattern: "WriteLog.*ERROR|WriteLog.*failed"
---

<objective>
Audit -ErrorAction SilentlyContinue usage and replace inappropriate instances with proper error handling.

Purpose: Address DEBT-02 - the codebase has ~288 occurrences of SilentlyContinue in production modules. Many hide real errors that should be logged. Target: 50%+ reduction while keeping SilentlyContinue in cleanup code where it's appropriate.

Output: Production modules with improved error visibility while maintaining robust cleanup behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-tech-debt-cleanup/01-RESEARCH.md

# Key modules to audit
@FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1
@FFUDevelopment/Modules/FFU.VM/FFU.VM.psm1
@FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Categorize SilentlyContinue by type</name>
  <files></files>
  <action>
Analyze the ~288 SilentlyContinue occurrences in production modules and categorize:

Run grep to find all occurrences:
```powershell
grep -rn "SilentlyContinue" FFUDevelopment/Modules --include="*.psm1" | head -100
```

Categorize each into:

1. **KEEP - Cleanup code** (SilentlyContinue is correct):
   ```powershell
   Remove-Item -Path $temp -Force -ErrorAction SilentlyContinue
   Dismount-VHD -Path $vhd -ErrorAction SilentlyContinue
   Stop-VM -Name $vm -Force -ErrorAction SilentlyContinue
   ```

2. **KEEP - Guard patterns** (checking if something exists):
   ```powershell
   if (Get-Command WriteLog -ErrorAction SilentlyContinue) { ... }
   $exists = Get-VM -Name $VMName -ErrorAction SilentlyContinue
   ```

3. **REPLACE - Should use Test-Path first**:
   ```powershell
   # BEFORE
   $file = Get-Item -Path $path -ErrorAction SilentlyContinue
   # AFTER
   if (Test-Path -Path $path) { $file = Get-Item -Path $path }
   ```

4. **REPLACE - Should log errors**:
   ```powershell
   # BEFORE
   $volume = Get-Volume -DriveLetter $drive -ErrorAction SilentlyContinue
   # AFTER
   try {
       $volume = Get-Volume -DriveLetter $drive -ErrorAction Stop
   }
   catch {
       WriteLog "WARNING: Could not get volume for drive $drive: $($_.Exception.Message)"
       $volume = $null
   }
   ```

Create a working list of files and line numbers for each category.
  </action>
  <verify>Categorization complete with counts per category.</verify>
  <done>SilentlyContinue occurrences categorized: KEEP (cleanup/guard) vs REPLACE (should log).</done>
</task>

<task type="auto">
  <name>Task 2: Replace problematic SilentlyContinue instances</name>
  <files>FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1, FFUDevelopment/Modules/FFU.VM/FFU.VM.psm1, FFUDevelopment/Modules/FFU.Imaging/FFU.Imaging.psm1, FFUDevelopment/Modules/FFU.Media/FFU.Media.psm1, FFUDevelopment/Modules/FFU.Updates/FFU.Updates.psm1, FFUDevelopment/Modules/FFU.Drivers/FFU.Drivers.psm1</files>
  <action>
Replace problematic SilentlyContinue instances with proper error handling.

Target: ~130-150 replacements (50%+ of 288)

Focus on high-value modules in this order (highest impact first):
1. FFU.Core (~many occurrences)
2. FFU.VM (~many occurrences)
3. FFU.Imaging (~many occurrences)
4. FFU.Media, FFU.Updates, FFU.Drivers (remaining)

For each REPLACE instance, use the appropriate pattern:

**Pattern A: Test-Path first (for file/path operations)**
```powershell
# BEFORE
$item = Get-Item -Path $path -ErrorAction SilentlyContinue
# AFTER
if (Test-Path -Path $path) {
    $item = Get-Item -Path $path
} else {
    $item = $null
}
```

**Pattern B: Try/catch with logging (for operations that should be logged)**
```powershell
# BEFORE
$result = Some-Operation -ErrorAction SilentlyContinue
# AFTER
try {
    $result = Some-Operation -ErrorAction Stop
}
catch {
    WriteLog "WARNING: Operation failed: $($_.Exception.Message)"
    $result = $null
}
```

**Pattern C: Specific exception handling (for known failure modes)**
```powershell
try {
    $vm = Get-VM -Name $VMName -ErrorAction Stop
}
catch [Microsoft.HyperV.PowerShell.VirtualizationException] {
    WriteLog "VM '$VMName' does not exist"
    $vm = $null
}
```

IMPORTANT:
- Do NOT modify finally blocks or cleanup code
- Do NOT modify guard patterns (checking command existence)
- Do NOT modify Remove-Item, Dismount-*, Stop-* in cleanup contexts
  </action>
  <verify>
Count before: grep -c "SilentlyContinue" FFUDevelopment/Modules/*.psm1 (baseline ~288)
Count after: Should be ~130-150 remaining (50%+ reduction)
Modules still import without error.
  </verify>
  <done>SilentlyContinue reduced by 50%+ in production modules with proper error handling added.</done>
</task>

<task type="auto">
  <name>Task 3: Test error scenarios and update versions</name>
  <files>FFUDevelopment/version.json</files>
  <action>
1. Run comprehensive Pester tests:
   ```powershell
   Invoke-Pester -Path 'Tests/Unit' -Output Detailed
   ```

2. Run specific error path tests:
   ```powershell
   # Test cleanup still works when resources don't exist
   # Test error logging produces output
   # Test build doesn't fail on minor errors
   ```

3. Update version.json:
   - Increment main FFUBuilder patch version
   - Update buildDate
   - Add note about SilentlyContinue audit

4. Run PSScriptAnalyzer on modified modules:
   ```powershell
   Invoke-ScriptAnalyzer -Path FFUDevelopment/Modules -Recurse -Severity Error
   ```

5. Document the final count:
   ```powershell
   $before = 288  # From research
   $after = (Get-ChildItem FFUDevelopment/Modules -Filter *.psm1 -Recurse | Select-String "SilentlyContinue").Count
   $reduction = [math]::Round(($before - $after) / $before * 100, 1)
   Write-Output "Reduced SilentlyContinue from $before to $after ($reduction% reduction)"
   ```

Target: 50%+ reduction documented.
  </action>
  <verify>
Pester tests pass.
PSScriptAnalyzer reports no errors.
SilentlyContinue count reduced by 50%+ from baseline.
  </verify>
  <done>Error handling improved, tests pass, 50%+ SilentlyContinue reduction achieved and documented.</done>
</task>

</tasks>

<verification>
1. SilentlyContinue count reduced by 50%+ (from ~288 to ~130-150)
2. Cleanup code still uses SilentlyContinue (verified by inspection)
3. All Pester tests pass
4. PSScriptAnalyzer reports no errors
5. Error messages now logged where previously silenced
</verification>

<success_criteria>
- DEBT-02 complete: 50%+ reduction in -ErrorAction SilentlyContinue usage
- Quality: Errors are logged where previously silenced
- Robustness: Cleanup code still works (SilentlyContinue preserved in cleanup)
- No regressions: All tests pass, builds still work
</success_criteria>

<output>
After completion, create `.planning/phases/01-tech-debt-cleanup/01-05-SUMMARY.md`
</output>
