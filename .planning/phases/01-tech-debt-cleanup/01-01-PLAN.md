---
phase: 01-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CLAUDE.md
  - FFUDevelopment/BuildFFUVM_UI.ps1
autonomous: true

must_haves:
  truths:
    - "CLAUDE.md documents param block coupling with FFU.Constants"
    - "logStreamReader field is removed from UI state"
    - "UI build functionality works without logStreamReader"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Param coupling documentation"
      contains: "param block coupling"
    - path: "FFUDevelopment/BuildFFUVM_UI.ps1"
      provides: "Cleaned UI state without legacy field"
  key_links:
    - from: "FFUDevelopment/BuildFFUVM_UI.ps1"
      to: "FFU.Messaging module"
      via: "messagingContext field"
      pattern: "messagingContext"
---

<objective>
Document parameter block coupling and remove legacy logStreamReader field from UI.

Purpose: Address DEBT-05 (documentation) and DEBT-04 (legacy code removal) - the two lowest-risk tech debt items that can be completed together as they are both cleanup tasks with no code dependencies.

Output: Updated CLAUDE.md with coupling documentation, cleaned BuildFFUVM_UI.ps1 without legacy logStreamReader field.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-tech-debt-cleanup/01-RESEARCH.md

# Key files to modify
@CLAUDE.md
@FFUDevelopment/BuildFFUVM_UI.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document param block coupling in CLAUDE.md</name>
  <files>CLAUDE.md</files>
  <action>
Add a new section under "## Architecture" (or create "## Architecture" if it doesn't exist) titled "### Param Block Coupling".

Document the following coupling between BuildFFUVM.ps1 and FFU.Constants:

1. Explain WHY the coupling exists:
   - PowerShell param blocks are evaluated at parse time, before module imports
   - Using [FFUConstants]::CONSTANT in param defaults causes failure in ThreadJob contexts
   - Therefore, param block defaults MUST use hardcoded values

2. List the coupled parameters (from research lines 199-203):
   | Parameter | Default Value | FFU.Constants Property |
   |-----------|---------------|------------------------|
   | Memory | 4GB (4294967296) | DEFAULT_VM_MEMORY |
   | Disksize | 50GB (53687091200) | DEFAULT_VHDX_SIZE |
   | Processors | 4 | DEFAULT_VM_PROCESSORS |

3. Add a maintenance note: "If you change values in FFU.Constants.psm1, update BuildFFUVM.ps1 param defaults too!"

Reference: BuildFFUVM.ps1 lines 7-18 already have inline comments about this - document it properly in CLAUDE.md for discoverability.
  </action>
  <verify>
grep -i "param block coupling" CLAUDE.md shows the new section.
grep "Memory.*4GB" CLAUDE.md shows the coupling table.
  </verify>
  <done>CLAUDE.md contains a "Param Block Coupling" section explaining why BuildFFUVM.ps1 param defaults must be hardcoded and listing the coupled values.</done>
</task>

<task type="auto">
  <name>Task 2: Remove legacy logStreamReader from UI</name>
  <files>FFUDevelopment/BuildFFUVM_UI.ps1</files>
  <action>
Remove the legacy logStreamReader field and all its references from BuildFFUVM_UI.ps1.

Steps:
1. Find and remove `logStreamReader = $null` from $script:uiState.Data (around line 67)
2. Search for ALL references to `logStreamReader` in the file and remove them:
   - Cleanup code (lines ~236-240, ~482-491)
   - Fallback code (lines ~769-788)
   - Any other references

3. For fallback file reading (if messagingContext is null), the code should gracefully skip rather than use logStreamReader. The messagingContext is the primary and only mechanism now.

4. Update any comments that mention logStreamReader to reflect the removal.

IMPORTANT: Do NOT remove the messagingContext field or any FFU.Messaging integration - only remove logStreamReader.

Before making changes, grep for all logStreamReader occurrences to ensure complete removal.
  </action>
  <verify>
grep -c "logStreamReader" FFUDevelopment/BuildFFUVM_UI.ps1 returns 0.
PowerShell -Command "& { . .\FFUDevelopment\BuildFFUVM_UI.ps1 -WhatIf }" does not error (or UI imports cleanly).
  </verify>
  <done>logStreamReader field and all its references are removed from BuildFFUVM_UI.ps1. The messagingContext is now the only mechanism for UI/job communication.</done>
</task>

<task type="auto">
  <name>Task 3: Run verification tests</name>
  <files></files>
  <action>
Run existing Pester tests to ensure the UI still works:

1. Run UI-related tests:
   pwsh -Command "Invoke-Pester -Path 'Tests/UI' -Output Detailed" (if UI tests exist)

2. Run module import test:
   pwsh -Command "Import-Module ./FFUDevelopment/FFUUI.Core/FFUUI.Core.psd1 -Force -ErrorAction Stop; Write-Host 'Import successful'"

3. Verify no PSScriptAnalyzer errors introduced:
   pwsh -Command "Invoke-ScriptAnalyzer -Path FFUDevelopment/BuildFFUVM_UI.ps1 -Severity Error"

If any tests fail, fix the issues before completing this plan.
  </action>
  <verify>All tests pass. No PSScriptAnalyzer errors.</verify>
  <done>UI module imports cleanly, existing tests pass, no script analyzer errors.</done>
</task>

</tasks>

<verification>
1. CLAUDE.md grep for "param block coupling" returns matches
2. BuildFFUVM_UI.ps1 grep for "logStreamReader" returns 0 matches
3. FFUUI.Core module imports without error
4. PSScriptAnalyzer finds no errors in modified files
</verification>

<success_criteria>
- DEBT-05 complete: CLAUDE.md documents param block coupling with table of coupled values
- DEBT-04 complete: logStreamReader removed from UI, messagingContext is sole communication mechanism
- No regressions: UI module imports cleanly, tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-tech-debt-cleanup/01-01-SUMMARY.md`
</output>
