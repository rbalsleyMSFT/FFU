---
phase: 01-tech-debt-cleanup
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psm1
  - FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psd1
  - FFUDevelopment/version.json
autonomous: true

must_haves:
  truths:
    - "Write-Host in FFU.Preflight replaced with proper output streams"
    - "Preflight validation results visible in background job output"
    - "Interactive preflight still shows colored output when run directly"
  artifacts:
    - path: "FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psm1"
      provides: "Preflight module with proper output streams"
  key_links:
    - from: "FFU.Preflight.psm1"
      to: "WriteLog or Write-Information"
      via: "Output stream replacement"
      pattern: "WriteLog|Write-Information"
---

<objective>
Replace Write-Host with proper output streams in FFU.Preflight module.

Purpose: Address DEBT-03 (partial) - FFU.Preflight has 91 Write-Host occurrences for validation results display. These need careful replacement to maintain visual feedback in interactive mode while enabling background job capture.

Output: FFU.Preflight using WriteLog, Write-Information, or Write-Verbose for output that works in both interactive and background job contexts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-tech-debt-cleanup/01-RESEARCH.md

# Key file to modify
@FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psm1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze Write-Host usage patterns in FFU.Preflight</name>
  <files>FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psm1</files>
  <action>
Categorize the ~91 Write-Host occurrences by purpose:

1. **Validation headers** (e.g., "=== Checking Hyper-V ===")
   - Replace with: WriteLog for structured logging

2. **Pass/Fail status** (e.g., "[PASS] Hyper-V enabled")
   - Replace with: WriteLog with status prefix preserved

3. **Warning messages** (e.g., "WARNING: Switch not found")
   - Replace with: Write-Warning (proper stream)

4. **Error messages** (e.g., "ERROR: Critical failure")
   - Replace with: Write-Error or throw (proper stream)

5. **Detailed info** (e.g., "Found 4 virtual switches")
   - Replace with: Write-Verbose (diagnostic detail)

6. **Progress indicators** (e.g., "Checking item 3 of 10")
   - Replace with: Write-Progress or WriteLog

Create a brief analysis document or mental model of the patterns before making replacements.
  </action>
  <verify>Completed analysis of Write-Host patterns documented in memory.</verify>
  <done>Write-Host usage patterns categorized for systematic replacement.</done>
</task>

<task type="auto">
  <name>Task 2: Replace Write-Host with appropriate streams</name>
  <files>FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psm1</files>
  <action>
Systematically replace Write-Host occurrences based on Task 1 analysis:

For each category:

1. **Validation headers** -> WriteLog
   ```powershell
   # BEFORE
   Write-Host "=== Checking Hyper-V Configuration ===" -ForegroundColor Cyan
   # AFTER
   WriteLog "=== Checking Hyper-V Configuration ==="
   ```

2. **Pass status** -> WriteLog with status
   ```powershell
   # BEFORE
   Write-Host "[PASS] " -NoNewline -ForegroundColor Green
   Write-Host "Hyper-V is enabled"
   # AFTER
   WriteLog "[PASS] Hyper-V is enabled"
   ```

3. **Fail status** -> WriteLog with status
   ```powershell
   # BEFORE
   Write-Host "[FAIL] " -NoNewline -ForegroundColor Red
   Write-Host "Hyper-V is not enabled"
   # AFTER
   WriteLog "[FAIL] Hyper-V is not enabled"
   ```

4. **Warnings** -> Write-Warning
   ```powershell
   # BEFORE
   Write-Host "WARNING: Using default switch" -ForegroundColor Yellow
   # AFTER
   Write-Warning "Using default switch"
   ```

5. **Detailed diagnostic info** -> Write-Verbose
   ```powershell
   # BEFORE
   Write-Host "  - Found switch: $switchName"
   # AFTER
   Write-Verbose "Found switch: $switchName"
   ```

Important considerations:
- Remove -ForegroundColor, -BackgroundColor, -NoNewline parameters (not applicable to other cmdlets)
- Handle multi-line constructs (Write-Host with -NoNewline followed by another Write-Host)
- Ensure WriteLog function is available (import FFU.Common.Core if needed)
  </action>
  <verify>
grep -c "Write-Host" FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psm1 returns 0.
Module imports without error.
  </verify>
  <done>All Write-Host calls in FFU.Preflight replaced with appropriate output stream cmdlets.</done>
</task>

<task type="auto">
  <name>Task 3: Update version and run comprehensive tests</name>
  <files>FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psd1, FFUDevelopment/version.json</files>
  <action>
1. Update FFU.Preflight.psd1:
   - Increment patch version
   - Add release note: "Replaced Write-Host with proper output streams for background job compatibility"

2. Update version.json:
   - Increment main FFUBuilder patch version
   - Update FFU.Preflight version in modules section
   - Update buildDate

3. Run Pester tests:
   ```powershell
   Invoke-Pester -Path 'Tests/Unit/FFU.Preflight*.Tests.ps1' -Output Detailed
   ```

4. Run functional test - verify preflight still produces output:
   ```powershell
   Import-Module ./FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psd1 -Force
   # Run a basic preflight check and verify output is captured
   $output = & {
       $VerbosePreference = 'Continue'
       Test-FFUEnvironment -Verbose 4>&1 2>&1
   }
   $output.Count -gt 0  # Should have captured output
   ```

5. Run PSScriptAnalyzer:
   ```powershell
   Invoke-ScriptAnalyzer -Path FFUDevelopment/Modules/FFU.Preflight/FFU.Preflight.psm1 -Severity Error
   ```

If tests fail, fix issues before completing.
  </action>
  <verify>
Pester tests pass.
Functional test captures output.
PSScriptAnalyzer reports no errors.
  </verify>
  <done>FFU.Preflight version incremented, all tests pass, output is captured in job context.</done>
</task>

</tasks>

<verification>
1. grep "Write-Host" in FFU.Preflight.psm1 returns 0 matches
2. Module imports without error
3. Pester tests pass
4. Output is captured when run in job-like context (not going to console only)
5. PSScriptAnalyzer finds no errors
</verification>

<success_criteria>
- DEBT-03 (partial): Write-Host removed from FFU.Preflight (~91 replacements)
- Functional: Preflight output visible in background job context
- Functional: Validation pass/fail status preserved in output text
- No regressions: Module imports cleanly, tests pass
- Versioning: Module version incremented per policy
</success_criteria>

<output>
After completion, create `.planning/phases/01-tech-debt-cleanup/01-04-SUMMARY.md`
</output>
