---
phase: 08-feature-progress-checkpoint
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psm1
  - FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psd1
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Build state can be saved to JSON file at checkpoint"
    - "Saved checkpoint can be loaded and validated"
    - "Checkpoint file is created atomically to prevent corruption"
    - "Invalid or stale checkpoints are detected and rejected"
  artifacts:
    - path: "FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psm1"
      provides: "Core checkpoint functions"
      exports: ["Save-FFUBuildCheckpoint", "Get-FFUBuildCheckpoint", "Remove-FFUBuildCheckpoint", "Test-FFUBuildCheckpoint"]
    - path: "FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psd1"
      provides: "Module manifest"
      contains: "ModuleVersion"
  key_links:
    - from: "FFU.Checkpoint"
      to: "ConvertTo-Json"
      via: "State serialization"
      pattern: "ConvertTo-Json.*-Depth"
    - from: "FFU.Checkpoint"
      to: "FFUBuildPhase enum"
      via: "Phase ordering"
      pattern: "enum FFUBuildPhase"
---

<objective>
Create FFU.Checkpoint module with core checkpoint persistence functions.

Purpose: Enable build state to be saved at phase boundaries and loaded on script restart, providing the foundation for checkpoint/resume capability.
Output: New FFU.Checkpoint module with Save/Get/Remove/Test functions and FFUBuildPhase enum.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-feature-progress-checkpoint/08-RESEARCH.md

# Existing patterns
@FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1 (lines 2167-2500 - cleanup registry pattern)
@FFUDevelopment/Modules/FFU.Messaging/FFU.Messaging.psm1 (FFUBuildState enum pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FFU.Checkpoint module structure</name>
  <files>
    FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psm1
    FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psd1
  </files>
  <action>
Create the FFU.Checkpoint module with the following components:

1. **FFUBuildPhase Enum** (defines phase ordering):
```powershell
enum FFUBuildPhase {
    NotStarted = 0
    PreflightValidation = 1
    DriverDownload = 2
    UpdatesDownload = 3
    AppsPreparation = 4
    VHDXCreation = 5
    WindowsUpdates = 6
    VMSetup = 7
    VMStart = 8
    AppInstallation = 9
    VMShutdown = 10
    FFUCapture = 11
    DeploymentMedia = 12
    USBCreation = 13
    Cleanup = 14
    Completed = 15
}
```

2. **Save-FFUBuildCheckpoint** function:
   - Parameters: CompletedPhase (FFUBuildPhase), Configuration (hashtable), Artifacts (hashtable), Paths (hashtable), FFUDevelopmentPath (string)
   - Creates `.ffubuilder` directory if not exists
   - Builds checkpoint object with: version="1.0", buildId (from VMName), timestamp (UTC ISO 8601), lastCompletedPhase, percentComplete (calculated from phase), configuration, artifacts, paths
   - Uses atomic write pattern: write to .tmp file, then Move-Item -Force to final path
   - Checkpoint path: `{FFUDevelopmentPath}/.ffubuilder/checkpoint.json`
   - MUST NOT include sensitive data (passwords, credentials)
   - Calls WriteLog if available (check with Get-Command -ErrorAction SilentlyContinue)

3. **Get-FFUBuildCheckpoint** function:
   - Parameters: FFUDevelopmentPath (string)
   - Returns $null if no checkpoint file exists
   - Loads JSON, converts to hashtable (use -AsHashtable for PS7+, manual conversion for PS5.1)
   - Validates version field matches "1.0"
   - Returns checkpoint hashtable or $null on validation failure

4. **Remove-FFUBuildCheckpoint** function:
   - Parameters: FFUDevelopmentPath (string)
   - Removes checkpoint file if exists
   - Safe to call even if no checkpoint exists (use -ErrorAction SilentlyContinue)

5. **Test-FFUBuildCheckpoint** function:
   - Parameters: FFUDevelopmentPath (string), Checkpoint (hashtable, optional)
   - Loads checkpoint if not provided
   - Validates: version matches, required fields present, artifact paths exist (for paths in artifacts with $true value)
   - Returns $true/$false

6. **Get-FFUBuildPhasePercent** (helper):
   - Parameters: Phase (FFUBuildPhase)
   - Returns approximate percent complete for each phase (PreflightValidation=5, DriverDownload=15, etc.)

**Module manifest (psd1)**:
- ModuleVersion = '1.0.0'
- Description = 'Build checkpoint and resume functionality for FFU Builder'
- RequiredModules = @() (no dependencies - must work early in build)
- FunctionsToExport = Save-FFUBuildCheckpoint, Get-FFUBuildCheckpoint, Remove-FFUBuildCheckpoint, Test-FFUBuildCheckpoint
  </action>
  <verify>
```powershell
# Import module
Import-Module "C:\claude\FFUBuilder\FFUDevelopment\Modules\FFU.Checkpoint" -Force

# Verify exports
Get-Command -Module FFU.Checkpoint | Select-Object Name

# Verify enum exists
[FFUBuildPhase]::VHDXCreation -eq 5
```
  </verify>
  <done>
FFU.Checkpoint module exists with 4 exported functions and FFUBuildPhase enum. Module imports without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement checkpoint save/load with atomic writes</name>
  <files>
    FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psm1
  </files>
  <action>
Implement the core checkpoint persistence logic:

1. **Save-FFUBuildCheckpoint implementation**:
```powershell
function Save-FFUBuildCheckpoint {
    [CmdletBinding()]
    [OutputType([void])]
    param(
        [Parameter(Mandatory)]
        [FFUBuildPhase]$CompletedPhase,

        [Parameter(Mandatory)]
        [hashtable]$Configuration,

        [Parameter(Mandatory)]
        [hashtable]$Artifacts,

        [Parameter(Mandatory)]
        [hashtable]$Paths,

        [Parameter(Mandatory)]
        [string]$FFUDevelopmentPath
    )

    $checkpointDir = Join-Path $FFUDevelopmentPath ".ffubuilder"
    $checkpointPath = Join-Path $checkpointDir "checkpoint.json"
    $tempPath = "$checkpointPath.tmp"

    # Create directory if needed
    if (-not (Test-Path $checkpointDir)) {
        New-Item -Path $checkpointDir -ItemType Directory -Force | Out-Null
    }

    # Build checkpoint object
    $checkpoint = [PSCustomObject]@{
        version = "1.0"
        buildId = $Configuration.VMName
        timestamp = (Get-Date).ToUniversalTime().ToString("o")
        lastCompletedPhase = $CompletedPhase.ToString()
        percentComplete = Get-FFUBuildPhasePercent -Phase $CompletedPhase
        configuration = $Configuration
        artifacts = $Artifacts
        paths = $Paths
    }

    # Atomic write: temp file then rename
    $checkpoint | ConvertTo-Json -Depth 10 | Set-Content -Path $tempPath -Encoding UTF8 -Force
    Move-Item -Path $tempPath -Destination $checkpointPath -Force

    # Log if available
    if (Get-Command WriteLog -ErrorAction SilentlyContinue) {
        WriteLog "Checkpoint saved: Phase $CompletedPhase ($($checkpoint.percentComplete)%)"
    }
}
```

2. **Get-FFUBuildCheckpoint implementation**:
   - Handle PS5.1 vs PS7+ difference for -AsHashtable
   - Use `$PSVersionTable.PSVersion.Major -ge 7` to detect
   - For PS5.1, manually convert PSCustomObject to hashtable recursively

3. **Test-FFUBuildCheckpoint implementation**:
   - Check version == "1.0"
   - Check required fields: buildId, timestamp, lastCompletedPhase, configuration, artifacts, paths
   - For each artifact with value $true, verify the path exists (if path is stored)
   - Return validation result with reason on failure (Write-Verbose)

4. **Cross-version compatibility**:
   - Do NOT use features only in PS7+ (like null-conditional operators)
   - Use explicit if/else instead of ternary operators
   - Test ConvertFrom-Json compatibility
  </action>
  <verify>
```powershell
Import-Module "C:\claude\FFUBuilder\FFUDevelopment\Modules\FFU.Checkpoint" -Force

# Test save
$testPath = "C:\claude\FFUBuilder\FFUDevelopment"
Save-FFUBuildCheckpoint -CompletedPhase VHDXCreation `
    -Configuration @{ VMName = "TestBuild"; WindowsRelease = "24H2" } `
    -Artifacts @{ vhdxCreated = $true; driversDownloaded = $false } `
    -Paths @{ VHDXPath = "C:\test.vhdx" } `
    -FFUDevelopmentPath $testPath

# Verify file created
Test-Path "$testPath\.ffubuilder\checkpoint.json"

# Test load
$checkpoint = Get-FFUBuildCheckpoint -FFUDevelopmentPath $testPath
$checkpoint.lastCompletedPhase -eq "VHDXCreation"

# Cleanup test
Remove-FFUBuildCheckpoint -FFUDevelopmentPath $testPath
-not (Test-Path "$testPath\.ffubuilder\checkpoint.json")
```
  </verify>
  <done>
Checkpoint save creates atomic JSON file, load returns hashtable, validation works for version and field checks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for FFU.Checkpoint module</name>
  <files>
    Tests/Unit/FFU.Checkpoint.Tests.ps1
  </files>
  <action>
Create comprehensive Pester 5.x tests for FFU.Checkpoint module:

1. **Describe "FFU.Checkpoint Module"**:
   - It "imports without errors"
   - It "exports expected functions"
   - It "defines FFUBuildPhase enum"

2. **Describe "Save-FFUBuildCheckpoint"**:
   - It "creates checkpoint directory if not exists"
   - It "creates checkpoint.json file"
   - It "writes valid JSON structure"
   - It "includes all required fields"
   - It "uses atomic write (temp file pattern)"
   - It "calculates correct percent complete"
   - It "stores UTC ISO 8601 timestamp"

3. **Describe "Get-FFUBuildCheckpoint"**:
   - It "returns null when no checkpoint exists"
   - It "loads valid checkpoint"
   - It "returns hashtable (not PSCustomObject)"
   - It "preserves nested structures"
   - It "returns null for invalid version"

4. **Describe "Remove-FFUBuildCheckpoint"**:
   - It "removes existing checkpoint"
   - It "does not error when no checkpoint exists"
   - It "leaves directory intact (only removes file)"

5. **Describe "Test-FFUBuildCheckpoint"**:
   - It "returns true for valid checkpoint"
   - It "returns false for missing version"
   - It "returns false for wrong version"
   - It "returns false for missing required fields"
   - It "validates artifact paths when artifacts have true values"

6. **Describe "Get-FFUBuildPhasePercent"**:
   - It "returns correct percent for each phase"
   - It "returns 0 for NotStarted"
   - It "returns 100 for Completed"

Use BeforeAll to set up test directory, AfterAll to clean up. Use $TestDrive for temp files.
  </action>
  <verify>
```powershell
Invoke-Pester -Path "C:\claude\FFUBuilder\Tests\Unit\FFU.Checkpoint.Tests.ps1" -Output Detailed -PassThru
```
  </verify>
  <done>
FFU.Checkpoint.Tests.ps1 exists with 20+ tests covering all functions, all tests pass.
  </done>
</task>

</tasks>

<verification>
1. Module imports: `Import-Module FFU.Checkpoint -Force` succeeds
2. Functions exported: `(Get-Command -Module FFU.Checkpoint).Count -eq 4`
3. Enum exists: `[FFUBuildPhase]::Completed -eq 15`
4. Save/load cycle works: checkpoint created, loaded, matches
5. Tests pass: `Invoke-Pester` shows all green
</verification>

<success_criteria>
- FFU.Checkpoint module exists in FFUDevelopment/Modules/
- Module exports: Save-FFUBuildCheckpoint, Get-FFUBuildCheckpoint, Remove-FFUBuildCheckpoint, Test-FFUBuildCheckpoint
- FFUBuildPhase enum defines 16 phases (NotStarted through Completed)
- Checkpoint JSON written atomically (temp + rename)
- Cross-version compatible (PS5.1 and PS7+)
- 20+ Pester tests all passing
</success_criteria>

<output>
After completion, create `.planning/phases/08-feature-progress-checkpoint/08-01-SUMMARY.md`
</output>
