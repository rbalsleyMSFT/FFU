---
phase: 03-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/FFU.Common/FFU.Common.Drivers.psm1
  - FFUDevelopment/FFUUI.Core/FFUUI.Core.Drivers.Lenovo.psm1
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Lenovo PSREF token is cached after retrieval"
    - "Cached token is reused for subsequent requests within 60 minutes"
    - "Expired cache triggers fresh browser automation"
    - "Cache uses DPAPI encryption via Export-Clixml"
  artifacts:
    - path: "FFUDevelopment/FFU.Common/FFU.Common.Drivers.psm1"
      provides: "Token caching functions"
      exports: ["Get-LenovoPSREFTokenCached", "Set-LenovoPSREFTokenCache", "Clear-LenovoPSREFTokenCache"]
  key_links:
    - from: "FFUUI.Core.Drivers.Lenovo.psm1"
      to: "FFU.Common.Drivers.psm1"
      via: "Get-LenovoPSREFTokenCached call"
      pattern: "Get-LenovoPSREFTokenCached"
---

<objective>
Implement Lenovo PSREF token caching to reduce browser automation exposure (SEC-01).

Purpose: The current implementation launches Edge browser automation on every Lenovo driver query. By caching the token with a 60-minute expiry, we reduce browser automation calls significantly during multi-model driver downloads.

Output: Cached token system with DPAPI encryption, automatic expiry handling, and fallback to fresh retrieval.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-hardening/03-RESEARCH.md

# Source files
@FFUDevelopment/FFU.Common/FFU.Common.Drivers.psm1
@FFUDevelopment/FFUUI.Core/FFUUI.Core.Drivers.Lenovo.psm1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add token caching functions to FFU.Common.Drivers.psm1</name>
  <files>FFUDevelopment/FFU.Common/FFU.Common.Drivers.psm1</files>
  <action>
Add three new functions to FFU.Common.Drivers.psm1:

1. `Get-LenovoPSREFTokenCached`:
   - Parameters: `[string]$FFUDevelopmentPath`, `[int]$CacheValidMinutes = 60`, `[switch]$ForceRefresh`
   - Check cache first (unless ForceRefresh)
   - Cache location: `$FFUDevelopmentPath\.security\token-cache\lenovo-psref.xml`
   - If cached token exists and age < CacheValidMinutes, return cached token
   - Otherwise, call existing `Get-LenovoPSREFToken` and cache result
   - Use `Export-Clixml` for DPAPI encryption
   - Attempt NTFS encryption via `(Get-Item $cachePath).Encrypt()` with try/catch (non-fatal if unavailable)
   - Log cache hits/misses with WriteLog

2. `Set-LenovoPSREFTokenCache`:
   - Parameters: `[string]$FFUDevelopmentPath`, `[string]$Token`
   - Create `.security\token-cache` directory if missing
   - Store hashtable with Token and Timestamp (ISO 8601 format)
   - Export with Export-Clixml
   - Apply NTFS encryption (try/catch, non-fatal)

3. `Clear-LenovoPSREFTokenCache`:
   - Parameters: `[string]$FFUDevelopmentPath`
   - Remove cached token file if exists
   - Log removal

Export all three functions in the module's Export-ModuleMember.

Reference research pattern in 03-RESEARCH.md for implementation structure.
  </action>
  <verify>
Import-Module FFU.Common -Force should not throw errors.
Get-Command -Module FFU.Common should list all three new functions.
  </verify>
  <done>
Three token caching functions implemented with DPAPI encryption support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate cached token retrieval into Lenovo driver workflow</name>
  <files>FFUDevelopment/FFUUI.Core/FFUUI.Core.Drivers.Lenovo.psm1</files>
  <action>
Modify `Get-LenovoDriversModelList` function in FFUUI.Core.Drivers.Lenovo.psm1:

1. Before the existing `$lenovoCookie = Get-LenovoPSREFToken` line:
   - Add parameter to receive FFUDevelopmentPath (or derive from $PSScriptRoot)
   - Call `Get-LenovoPSREFTokenCached -FFUDevelopmentPath $ffuDevelopmentPath` instead of `Get-LenovoPSREFToken`

2. The function currently calls `Get-LenovoPSREFToken` at line 29. Replace this with:
   ```powershell
   # Derive FFUDevelopmentPath from module location
   $ffuDevelopmentPath = Split-Path -Path (Split-Path -Path $PSScriptRoot -Parent) -Parent
   if ([string]::IsNullOrWhiteSpace($ffuDevelopmentPath)) {
       $ffuDevelopmentPath = $PSScriptRoot
   }

   # Use cached token retrieval to reduce browser automation
   $lenovoCookie = Get-LenovoPSREFTokenCached -FFUDevelopmentPath $ffuDevelopmentPath
   ```

3. Add WriteLog statement indicating cache was used or fresh token was retrieved.

4. Handle null/empty token gracefully - if caching fails, fall back to direct call.

WHY NOT modify FFU.Common.Drivers.psm1's existing Get-LenovoPSREFToken: Keep the atomic browser automation function unchanged. The caching wrapper provides the optimization while the core function remains testable in isolation.
  </action>
  <verify>
Search for `Get-LenovoPSREFTokenCached` in FFUUI.Core.Drivers.Lenovo.psm1 - should find the call.
Import-Module FFUUI.Core -Force should not throw errors.
  </verify>
  <done>
Lenovo driver workflow uses cached token retrieval, reducing browser automation calls.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Pester tests for token caching</name>
  <files>Tests/Unit/FFU.Common.Drivers.TokenCache.Tests.ps1</files>
  <action>
Create new test file `Tests/Unit/FFU.Common.Drivers.TokenCache.Tests.ps1`:

```powershell
BeforeAll {
    # Import the module
    $modulePath = Join-Path $PSScriptRoot "..\..\FFUDevelopment\FFU.Common\FFU.Common.Drivers.psm1"
    Import-Module $modulePath -Force
}

Describe "Lenovo PSREF Token Caching" {
    BeforeEach {
        # Create temp directory for testing
        $script:testPath = Join-Path $TestDrive "FFUDevelopment"
        New-Item -Path $testPath -ItemType Directory -Force | Out-Null
    }

    Context "Set-LenovoPSREFTokenCache" {
        It "Creates .security\token-cache directory if missing" {
            Set-LenovoPSREFTokenCache -FFUDevelopmentPath $testPath -Token "test-token-123"

            $cacheDir = Join-Path $testPath ".security\token-cache"
            $cacheDir | Should -Exist
        }

        It "Stores token with timestamp in XML file" {
            Set-LenovoPSREFTokenCache -FFUDevelopmentPath $testPath -Token "test-token-456"

            $cachePath = Join-Path $testPath ".security\token-cache\lenovo-psref.xml"
            $cachePath | Should -Exist

            $cached = Import-Clixml -Path $cachePath
            $cached.Token | Should -Be "test-token-456"
            $cached.Timestamp | Should -Not -BeNullOrEmpty
        }
    }

    Context "Get-LenovoPSREFTokenCached" {
        It "Returns cached token when within expiry window" {
            # Pre-populate cache
            $cacheDir = Join-Path $testPath ".security\token-cache"
            New-Item -Path $cacheDir -ItemType Directory -Force | Out-Null
            $cachePath = Join-Path $cacheDir "lenovo-psref.xml"
            @{
                Token = "cached-token-789"
                Timestamp = (Get-Date).ToString('o')
            } | Export-Clixml -Path $cachePath

            # Mock Get-LenovoPSREFToken to verify it's NOT called
            Mock Get-LenovoPSREFToken { "fresh-token" }

            $result = Get-LenovoPSREFTokenCached -FFUDevelopmentPath $testPath -CacheValidMinutes 60

            $result | Should -Be "cached-token-789"
            Should -Not -Invoke Get-LenovoPSREFToken
        }

        It "Retrieves fresh token when cache is expired" {
            # Pre-populate expired cache
            $cacheDir = Join-Path $testPath ".security\token-cache"
            New-Item -Path $cacheDir -ItemType Directory -Force | Out-Null
            $cachePath = Join-Path $cacheDir "lenovo-psref.xml"
            @{
                Token = "expired-token"
                Timestamp = (Get-Date).AddMinutes(-120).ToString('o')
            } | Export-Clixml -Path $cachePath

            # Mock Get-LenovoPSREFToken
            Mock Get-LenovoPSREFToken { "fresh-token" }
            Mock WriteLog {}

            $result = Get-LenovoPSREFTokenCached -FFUDevelopmentPath $testPath -CacheValidMinutes 60

            $result | Should -Be "fresh-token"
            Should -Invoke Get-LenovoPSREFToken -Times 1
        }

        It "ForceRefresh bypasses cache" {
            # Pre-populate valid cache
            $cacheDir = Join-Path $testPath ".security\token-cache"
            New-Item -Path $cacheDir -ItemType Directory -Force | Out-Null
            $cachePath = Join-Path $cacheDir "lenovo-psref.xml"
            @{
                Token = "cached-token"
                Timestamp = (Get-Date).ToString('o')
            } | Export-Clixml -Path $cachePath

            Mock Get-LenovoPSREFToken { "forced-fresh-token" }
            Mock WriteLog {}

            $result = Get-LenovoPSREFTokenCached -FFUDevelopmentPath $testPath -ForceRefresh

            $result | Should -Be "forced-fresh-token"
            Should -Invoke Get-LenovoPSREFToken -Times 1
        }
    }

    Context "Clear-LenovoPSREFTokenCache" {
        It "Removes cached token file" {
            # Pre-populate cache
            $cacheDir = Join-Path $testPath ".security\token-cache"
            New-Item -Path $cacheDir -ItemType Directory -Force | Out-Null
            $cachePath = Join-Path $cacheDir "lenovo-psref.xml"
            @{ Token = "test"; Timestamp = (Get-Date).ToString('o') } | Export-Clixml -Path $cachePath

            Mock WriteLog {}

            Clear-LenovoPSREFTokenCache -FFUDevelopmentPath $testPath

            $cachePath | Should -Not -Exist
        }
    }
}
```

Note: Tests mock WriteLog and Get-LenovoPSREFToken to isolate caching logic.
  </action>
  <verify>
Invoke-Pester -Path "Tests/Unit/FFU.Common.Drivers.TokenCache.Tests.ps1" -Output Detailed
All tests should pass.
  </verify>
  <done>
Pester tests validate token caching behavior: cache hits, expiry, forced refresh, and cache clearing.
  </done>
</task>

</tasks>

<verification>
1. Module imports: `Import-Module FFU.Common -Force` and `Import-Module FFUUI.Core -Force` succeed
2. Functions exist: `Get-Command Get-LenovoPSREFTokenCached` returns function info
3. Pester tests pass: `Invoke-Pester Tests/Unit/FFU.Common.Drivers.TokenCache.Tests.ps1`
4. No regressions: Existing driver tests still pass
</verification>

<success_criteria>
- Three token caching functions implemented and exported from FFU.Common.Drivers.psm1
- FFUUI.Core.Drivers.Lenovo.psm1 uses cached token retrieval
- DPAPI encryption via Export-Clixml protects cached tokens
- 60-minute default expiry reduces browser automation frequency
- All Pester tests pass (new and existing)
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-hardening/03-01-SUMMARY.md`
</output>
