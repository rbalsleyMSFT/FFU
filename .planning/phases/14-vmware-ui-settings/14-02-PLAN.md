---
phase: 14-vmware-ui-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1
  - FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1
  - FFUDevelopment/config/ffubuilder-config.schema.json
autonomous: true

must_haves:
  truths:
    - "Existing configs without VMwareSettings get defaults on load"
    - "Schema version is 1.2 after migration"
    - "Backup created before migration"
    - "Migration log includes VMwareSettings addition message"
  artifacts:
    - path: "FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1"
      provides: "Schema v1.2 migration with VMwareSettings defaults"
      contains: "VMwareSettings"
    - path: "FFUDevelopment/config/ffubuilder-config.schema.json"
      provides: "Schema documentation with VMwareSettings definition"
      contains: "VMwareSettings"
  key_links:
    - from: "FFU.ConfigMigration.psm1"
      to: "VMwareSettings"
      via: "Migration block adding defaults"
      pattern: "if \\(-not.*ContainsKey.*VMwareSettings"
    - from: "FFU.ConfigMigration.psm1"
      to: "configSchemaVersion"
      via: "Version constant update"
      pattern: "CurrentConfigSchemaVersion.*1\\.2"
---

<objective>
Implement config schema migration from v1.1 to v1.2 to add VMwareSettings defaults to existing configurations.

Purpose: Ensure existing users' configuration files are automatically upgraded with sensible defaults (NetworkType=nat, NicType=e1000e) when they upgrade to v1.8.2, preventing null/missing values.

Output: Updated ConfigMigration module that handles v1.1 -> v1.2 migration, schema documentation updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.8.2-ROADMAP.md
@.planning/milestones/v1.8.2-REQUIREMENTS.md
@.planning/phases/14-vmware-ui-settings/14-RESEARCH.md

Key reference files:
@FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1 (full file - migration patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add VMwareSettings migration to FFU.ConfigMigration</name>
  <files>
    FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1
    FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1
  </files>
  <action>
**FFU.ConfigMigration.psm1:**

1. **Update schema version constant (line 27):**
   Change: `$script:CurrentConfigSchemaVersion = "1.1"`
   To: `$script:CurrentConfigSchemaVersion = "1.2"`

2. **Add VMwareSettings migration block in Invoke-FFUConfigMigration function:**
   After the IncludePreviewUpdates migration block (around line 443), add:

```powershell
#region Migration: Add VMwareSettings defaults (v1.2)
if (-not $migrated.ContainsKey('VMwareSettings')) {
    $migrated['VMwareSettings'] = @{
        NetworkType = 'nat'
        NicType = 'e1000e'
    }
    $changes += "Added default 'VMwareSettings' (NetworkType=nat, NicType=e1000e)"
}
elseif ($migrated['VMwareSettings'] -is [hashtable]) {
    # VMwareSettings exists but may be missing properties - ensure both keys exist
    if (-not $migrated['VMwareSettings'].ContainsKey('NetworkType')) {
        $migrated['VMwareSettings']['NetworkType'] = 'nat'
        $changes += "Added missing 'VMwareSettings.NetworkType=nat'"
    }
    if (-not $migrated['VMwareSettings'].ContainsKey('NicType')) {
        $migrated['VMwareSettings']['NicType'] = 'e1000e'
        $changes += "Added missing 'VMwareSettings.NicType=e1000e'"
    }
}
#endregion
```

**FFU.ConfigMigration.psd1:**

1. Increment ModuleVersion (e.g., 1.0.0 -> 1.1.0)
2. Add ReleaseNotes: "Added v1.2 schema migration for VMwareSettings (NetworkType, NicType)"
  </action>
  <verify>
1. Verify schema version updated:
   `pwsh -c "Import-Module 'FFUDevelopment/Modules/FFU.ConfigMigration'; Get-FFUConfigSchemaVersion"` - should return "1.2"

2. Test migration with mock v1.1 config:
```powershell
pwsh -c @"
Import-Module 'FFUDevelopment/Modules/FFU.ConfigMigration' -Force
`$oldConfig = @{
    configSchemaVersion = '1.1'
    FFUDevelopmentPath = 'C:\FFU'
    IncludePreviewUpdates = `$false
}
`$result = Invoke-FFUConfigMigration -Config `$oldConfig
Write-Host 'Migrated to:' `$result.ToVersion
Write-Host 'VMwareSettings:' (`$result.Config.VMwareSettings | ConvertTo-Json -Compress)
Write-Host 'Changes:' (`$result.Changes -join '; ')
"@
```
Expected: ToVersion=1.2, VMwareSettings={NetworkType:"nat",NicType:"e1000e"}, Changes includes "Added default 'VMwareSettings'"

3. Test migration with pre-versioning config (no configSchemaVersion):
```powershell
pwsh -c @"
Import-Module 'FFUDevelopment/Modules/FFU.ConfigMigration' -Force
`$legacyConfig = @{
    FFUDevelopmentPath = 'C:\FFU'
    Verbose = `$true
}
`$result = Invoke-FFUConfigMigration -Config `$legacyConfig
Write-Host 'From:' `$result.FromVersion 'To:' `$result.ToVersion
Write-Host 'Has VMwareSettings:' (`$result.Config.ContainsKey('VMwareSettings'))
"@
```
Expected: From 0.0 to 1.2, Has VMwareSettings: True
  </verify>
  <done>
    - Schema version constant updated to 1.2
    - VMwareSettings migration block added with nat/e1000e defaults
    - Migration handles both missing VMwareSettings and partial VMwareSettings
    - Module manifest version incremented
  </done>
</task>

<task type="auto">
  <name>Task 2: Update schema documentation and run Pester tests</name>
  <files>FFUDevelopment/config/ffubuilder-config.schema.json</files>
  <action>
**ffubuilder-config.schema.json:**

Add VMwareSettings to the schema definition (this file is documentation, not validation):

1. Update `$schema` or `version` field if present to reflect v1.2
2. Add VMwareSettings property definition:

```json
"VMwareSettings": {
  "type": "object",
  "description": "VMware Workstation Pro network configuration settings",
  "properties": {
    "NetworkType": {
      "type": "string",
      "enum": ["nat", "bridged", "hostonly"],
      "default": "nat",
      "description": "Network connection type: 'nat' (share host IP), 'bridged' (direct network access), 'hostonly' (isolated)"
    },
    "NicType": {
      "type": "string",
      "enum": ["e1000e", "vmxnet3", "e1000"],
      "default": "e1000e",
      "description": "Virtual network adapter type: 'e1000e' (recommended for WinPE), 'vmxnet3' (best performance, requires VMware Tools), 'e1000' (legacy)"
    }
  },
  "required": ["NetworkType", "NicType"]
}
```

**Run verification tests:**

1. Run ConfigMigration Pester tests if they exist:
   `pwsh -c "Invoke-Pester -Path 'Tests/Unit/*ConfigMigration*' -Output Detailed"` (may not exist)

2. Run full unit test suite:
   `pwsh -c ".\Tests\Unit\Invoke-PesterTests.ps1"`

3. Run PSScriptAnalyzer:
   `pwsh -c "Invoke-ScriptAnalyzer -Path 'FFUDevelopment/Modules/FFU.ConfigMigration' -Recurse -Severity Error"`
  </action>
  <verify>
1. Check schema file has VMwareSettings:
   `pwsh -c "(Get-Content 'FFUDevelopment/config/ffubuilder-config.schema.json' -Raw) -match 'VMwareSettings'"` - should return True

2. JSON is valid:
   `pwsh -c "Get-Content 'FFUDevelopment/config/ffubuilder-config.schema.json' -Raw | ConvertFrom-Json | Out-Null; Write-Host 'Valid JSON'"` - should output "Valid JSON"

3. All tests pass
4. No PSScriptAnalyzer errors
  </verify>
  <done>
    - Schema documentation updated with VMwareSettings definition
    - JSON schema is valid
    - All Pester tests pass
    - No analyzer errors
  </done>
</task>

</tasks>

<verification>
**Migration verification:**
1. Create a test config file with schema v1.1 (no VMwareSettings)
2. Run migration: `Invoke-FFUConfigMigration -ConfigPath $path -CreateBackup`
3. Verify:
   - Backup file created (*.backup-TIMESTAMP)
   - configSchemaVersion = "1.2"
   - VMwareSettings.NetworkType = "nat"
   - VMwareSettings.NicType = "e1000e"
   - Changes array includes VMwareSettings addition message

**Integration verification:**
1. Launch UI with existing v1.1 config
2. UI should auto-migrate config on load
3. VMware dropdowns should show default values (NAT, E1000E)
4. Save config
5. Verify saved config has VMwareSettings with correct values

**Automated verification:**
- `pwsh -c ".\Tests\Unit\Invoke-PesterTests.ps1"` - All tests pass
- `pwsh -c "Invoke-ScriptAnalyzer -Path 'FFUDevelopment/Modules/FFU.ConfigMigration' -Recurse"` - No errors
</verification>

<success_criteria>
- [ ] Schema version constant is "1.2"
- [ ] VMwareSettings migration block added to Invoke-FFUConfigMigration
- [ ] Migration adds NetworkType=nat and NicType=e1000e defaults
- [ ] Migration handles both missing VMwareSettings and partial VMwareSettings
- [ ] Schema documentation (ffubuilder-config.schema.json) updated
- [ ] FFU.ConfigMigration module version incremented
- [ ] All Pester tests pass
- [ ] No PSScriptAnalyzer errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-vmware-ui-settings/14-02-SUMMARY.md`
</output>
