---
phase: 14-vmware-ui-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/BuildFFUVM_UI.xaml
  - FFUDevelopment/FFUUI.Core/FFUUI.Core.Initialize.psm1
  - FFUDevelopment/FFUUI.Core/FFUUI.Core.Shared.psm1
  - FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1
  - FFUDevelopment/FFUUI.Core/FFUUI.Core.psm1
autonomous: true

must_haves:
  truths:
    - "User can select VMware network type from dropdown when VMware is selected"
    - "User can select VMware NIC type from dropdown when VMware is selected"
    - "Dropdowns are disabled when Hyper-V is selected"
    - "Settings persist after save/load config cycle"
    - "UI defaults initialize VMware settings correctly on fresh launch"
  artifacts:
    - path: "FFUDevelopment/BuildFFUVM_UI.xaml"
      provides: "VMware NetworkType and NicType dropdown controls"
      contains: "cmbVMwareNetworkType"
    - path: "FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1"
      provides: "VMwareSettings save/load wiring"
      contains: "VMwareSettings"
    - path: "FFUDevelopment/FFUUI.Core/FFUUI.Core.psm1"
      provides: "Get-GeneralDefaults with VMwareSettings"
      contains: "VMwareSettings"
  key_links:
    - from: "BuildFFUVM_UI.xaml"
      to: "FFUUI.Core.Initialize.psm1"
      via: "FindName control registration"
      pattern: "cmbVMwareNetworkType"
    - from: "FFUUI.Core.Shared.psm1"
      to: "cmbVMwareNetworkType"
      via: "Update-HypervisorStatus IsEnabled"
      pattern: "cmbVMwareNetworkType\\.IsEnabled"
    - from: "FFUUI.Core.Config.psm1"
      to: "VMwareSettings"
      via: "Config save hashtable"
      pattern: "VMwareSettings.*NetworkType"
---

<objective>
Add VMware NetworkType and NicType dropdown controls to the UI with full config save/load wiring.

Purpose: Enable users to configure VMware network settings (bridged/nat/hostonly, e1000e/vmxnet3/e1000) directly from the UI instead of relying on hardcoded defaults.

Output: Working dropdown controls that persist settings across UI sessions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.8.2-ROADMAP.md
@.planning/milestones/v1.8.2-REQUIREMENTS.md
@.planning/phases/14-vmware-ui-settings/14-RESEARCH.md

Key reference files:
@FFUDevelopment/BuildFFUVM_UI.xaml (lines 90-180 - VM Settings section)
@FFUDevelopment/FFUUI.Core/FFUUI.Core.Initialize.psm1 (lines 155-180 - control registration)
@FFUDevelopment/FFUUI.Core/FFUUI.Core.Shared.psm1 (lines 1095-1156 - Update-HypervisorStatus)
@FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1 (lines 100-130 - Save-GeneralConfiguration, lines 550-570 - load)
@FFUDevelopment/FFUUI.Core/FFUUI.Core.psm1 (lines 200-250 - Get-GeneralDefaults)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add XAML dropdown controls for VMware NetworkType and NicType</name>
  <files>FFUDevelopment/BuildFFUVM_UI.xaml</files>
  <action>
Add two new rows to the VM Settings grid for VMware network configuration, following the existing VMware-specific control pattern (rows 2-3 for ShowVMConsole and ForceVMwareDrivers).

1. **Increase RowDefinitions count:** The current grid has 14 rows (indices 0-13). Add 2 more RowDefinition elements (Height="Auto") at the appropriate position.

2. **Insert VMware Network Type controls after row 3 (Force Driver Download):**
   - Insert at what will become row 4 (shift existing rows 4-13 down by 2)
   - Add StackPanel (x:Name="pnlVMwareNetworkTypeLabel") with TextBlock "VMware Network Type"
   - Add ComboBox (x:Name="cmbVMwareNetworkType") with items:
     - NAT (Tag="nat", IsSelected="True")
     - Bridged (Tag="bridged")
     - Host-Only (Tag="hostonly")
   - Set Visibility="Collapsed" and IsEnabled="False" initially (VMware only)
   - Width="200", similar styling to cmbLogicalSectorSize

3. **Insert VMware NIC Type controls as row 5:**
   - Add StackPanel (x:Name="pnlVMwareNicTypeLabel") with TextBlock "VMware NIC Type"
   - Add ComboBox (x:Name="cmbVMwareNicType") with items:
     - E1000E (Tag="e1000e", IsSelected="True")
     - VMXNET3 (Tag="vmxnet3")
     - E1000 (Tag="e1000")
   - Set Visibility="Collapsed" and IsEnabled="False" initially
   - Width="200"

4. **Update Grid.Row indices:** Increment Grid.Row by 2 for all controls from original row 4 onwards (VM Switch, Custom VM Switch, VM Host IP, Disk Size, Memory, Processors, VM Location, VM Name Prefix, Logical Sector Size, VM Shutdown Timeout).

ToolTips:
- VMware Network Type: "Select the network connection type for VMware VMs. NAT (default) shares host IP, Bridged connects directly to physical network, Host-Only isolates VM from external networks."
- VMware NIC Type: "Select the virtual network adapter type. E1000E (default) is recommended for WinPE compatibility. VMXNET3 offers best performance but requires VMware Tools drivers."
  </action>
  <verify>
1. Open BuildFFUVM_UI.xaml and verify:
   - Two new RowDefinition Height="Auto" elements added
   - cmbVMwareNetworkType exists with 3 ComboBoxItem children
   - cmbVMwareNicType exists with 3 ComboBoxItem children
   - Both have Visibility="Collapsed"
   - Grid.Row indices are correct (no gaps, no duplicates)
2. Run `pwsh -c "& { [xml]$x = Get-Content 'FFUDevelopment/BuildFFUVM_UI.xaml'; $x.Window.TabControl.TabItem[0].Grid.GroupBox.Grid.RowDefinitions.RowDefinition.Count }"` - should return 16 (was 14)
  </verify>
  <done>XAML contains cmbVMwareNetworkType and cmbVMwareNicType dropdowns with correct items and visibility settings</done>
</task>

<task type="auto">
  <name>Task 2: Wire UI controls and implement config save/load</name>
  <files>
    FFUDevelopment/FFUUI.Core/FFUUI.Core.Initialize.psm1
    FFUDevelopment/FFUUI.Core/FFUUI.Core.Shared.psm1
    FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1
    FFUDevelopment/FFUUI.Core/FFUUI.Core.psm1
  </files>
  <action>
**FFUUI.Core.Initialize.psm1 (control registration):**

After line ~166 (near chkIncludePreviewUpdates registration), add:
```powershell
# VMware network settings controls
$State.Controls.pnlVMwareNetworkTypeLabel = $window.FindName('pnlVMwareNetworkTypeLabel')
$State.Controls.cmbVMwareNetworkType = $window.FindName('cmbVMwareNetworkType')
$State.Controls.pnlVMwareNicTypeLabel = $window.FindName('pnlVMwareNicTypeLabel')
$State.Controls.cmbVMwareNicType = $window.FindName('cmbVMwareNicType')
```

**FFUUI.Core.Shared.psm1 (Update-HypervisorStatus):**

After line ~1124 (after forceVMwareDriversChk visibility block), add:
```powershell
# Show/hide and enable/disable VMware Network Type dropdown (VMware only)
$vmwareNetworkTypeLabel = $State.Controls.pnlVMwareNetworkTypeLabel
$vmwareNetworkTypeCombo = $State.Controls.cmbVMwareNetworkType
if ($null -ne $vmwareNetworkTypeLabel) {
    $vmwareNetworkTypeLabel.Visibility = $vmwareVisibility
}
if ($null -ne $vmwareNetworkTypeCombo) {
    $vmwareNetworkTypeCombo.Visibility = $vmwareVisibility
    $vmwareNetworkTypeCombo.IsEnabled = $showVMwareControls
}

# Show/hide and enable/disable VMware NIC Type dropdown (VMware only)
$vmwareNicTypeLabel = $State.Controls.pnlVMwareNicTypeLabel
$vmwareNicTypeCombo = $State.Controls.cmbVMwareNicType
if ($null -ne $vmwareNicTypeLabel) {
    $vmwareNicTypeLabel.Visibility = $vmwareVisibility
}
if ($null -ne $vmwareNicTypeCombo) {
    $vmwareNicTypeCombo.Visibility = $vmwareVisibility
    $vmwareNicTypeCombo.IsEnabled = $showVMwareControls
}
```

**FFUUI.Core.Config.psm1 (Save-GeneralConfiguration):**

After line ~117 (after VMHostIPAddress in the config hashtable), add:
```powershell
# VMware network settings (save Tag values, not display Content)
VMwareSettings = @{
    NetworkType = if ($null -ne $State.Controls.cmbVMwareNetworkType -and
                      $null -ne $State.Controls.cmbVMwareNetworkType.SelectedItem) {
        $State.Controls.cmbVMwareNetworkType.SelectedItem.Tag
    } else { 'nat' }
    NicType = if ($null -ne $State.Controls.cmbVMwareNicType -and
                  $null -ne $State.Controls.cmbVMwareNicType.SelectedItem) {
        $State.Controls.cmbVMwareNicType.SelectedItem.Tag
    } else { 'e1000e' }
}
```

**FFUUI.Core.Config.psm1 (Load config section, around line 567):**

After the IncludePreviewUpdates Set-UIValue line, add:
```powershell
# Load VMwareSettings - find and select ComboBoxItem by Tag
if ($null -ne $ConfigContent.VMwareSettings) {
    $vmwareSettings = $ConfigContent.VMwareSettings

    # Load NetworkType
    if ($null -ne $vmwareSettings.NetworkType -and $null -ne $State.Controls.cmbVMwareNetworkType) {
        $networkItem = $State.Controls.cmbVMwareNetworkType.Items |
            Where-Object { $_.Tag -eq $vmwareSettings.NetworkType } |
            Select-Object -First 1
        if ($null -ne $networkItem) {
            $State.Controls.cmbVMwareNetworkType.SelectedItem = $networkItem
        }
    }

    # Load NicType
    if ($null -ne $vmwareSettings.NicType -and $null -ne $State.Controls.cmbVMwareNicType) {
        $nicItem = $State.Controls.cmbVMwareNicType.Items |
            Where-Object { $_.Tag -eq $vmwareSettings.NicType } |
            Select-Object -First 1
        if ($null -ne $nicItem) {
            $State.Controls.cmbVMwareNicType.SelectedItem = $nicItem
        }
    }
}
```

**FFUUI.Core.psm1 (Get-GeneralDefaults):**

After line ~227 (after IncludePreviewUpdates), add:
```powershell
# VMware network settings defaults
VMwareSettings = @{
    NetworkType = 'nat'
    NicType = 'e1000e'
}
```
  </action>
  <verify>
1. Run PSScriptAnalyzer on modified files:
   `pwsh -c "Invoke-ScriptAnalyzer -Path 'FFUDevelopment/FFUUI.Core' -Recurse -Severity Error"`
2. Search for VMwareSettings in each file to confirm addition:
   `grep -n "VMwareSettings" FFUDevelopment/FFUUI.Core/*.psm1`
3. Search for cmbVMwareNetworkType registration:
   `grep -n "cmbVMwareNetworkType" FFUDevelopment/FFUUI.Core/*.psm1`
  </verify>
  <done>
    - Controls registered in Initialize.psm1 (4 new FindName calls)
    - Update-HypervisorStatus enables/disables dropdowns based on hypervisor selection
    - Config save includes VMwareSettings with NetworkType and NicType
    - Config load restores dropdown selections from saved VMwareSettings
    - Get-GeneralDefaults includes VMwareSettings with nat/e1000e defaults
  </done>
</task>

<task type="auto">
  <name>Task 3: Update module versions and run verification</name>
  <files>
    FFUDevelopment/FFUUI.Core/FFUUI.Core.psd1
    FFUDevelopment/version.json
  </files>
  <action>
1. **Update FFUUI.Core.psd1 manifest:**
   - Increment ModuleVersion (likely from current to +0.0.1)
   - Add ReleaseNotes entry: "Added VMware NetworkType and NicType UI controls with config persistence"

2. **Update version.json:**
   - Increment main version PATCH (e.g., 1.8.1 -> 1.8.2)
   - Update buildDate to current date
   - Update FFUUI.Core module version in modules section
   - Add note about VMware UI settings

3. **Run full verification:**
   - Launch UI: `pwsh -c "& { cd FFUDevelopment; .\BuildFFUVM_UI.ps1 }"` (close after launch confirms no errors)
   - Run Pester tests: `pwsh -c ".\Tests\Unit\Invoke-PesterTests.ps1"`
   - Run PSScriptAnalyzer: `pwsh -c "Invoke-ScriptAnalyzer -Path FFUDevelopment -Recurse -Severity Error"`
  </action>
  <verify>
1. Check version.json has updated version
2. Check FFUUI.Core.psd1 has new version and release notes
3. Pester tests pass (especially any UI-related tests)
4. No PSScriptAnalyzer errors
  </verify>
  <done>
    - FFUUI.Core module version incremented
    - Main FFU Builder version incremented to v1.8.2
    - All tests pass
    - No analyzer errors
  </done>
</task>

</tasks>

<verification>
**Functional verification (manual test):**
1. Launch BuildFFUVM_UI.ps1
2. Verify VMware dropdowns are NOT visible when Hyper-V is selected
3. Select "VMware Workstation Pro" from Hypervisor Type dropdown
4. Verify VMware NetworkType and NicType dropdowns become visible and enabled
5. Change NetworkType to "Bridged" and NicType to "VMXNET3"
6. Save configuration
7. Close and reopen UI, load the saved config
8. Verify NetworkType shows "Bridged" and NicType shows "VMXNET3"
9. Select "Hyper-V" from Hypervisor Type
10. Verify VMware dropdowns become hidden/disabled

**Automated verification:**
- `pwsh -c ".\Tests\Unit\Invoke-PesterTests.ps1"` - All tests pass
- `pwsh -c "Invoke-ScriptAnalyzer -Path FFUDevelopment -Recurse -Severity Error"` - No errors
</verification>

<success_criteria>
- [ ] cmbVMwareNetworkType and cmbVMwareNicType exist in XAML with correct items
- [ ] Dropdowns visible only when VMware is selected (Visibility changes)
- [ ] Dropdowns enabled only when VMware is selected (IsEnabled changes)
- [ ] VMwareSettings saved to config file with NetworkType and NicType
- [ ] VMwareSettings loaded from config file restores dropdown selections
- [ ] Get-GeneralDefaults provides nat/e1000e defaults
- [ ] All Pester tests pass
- [ ] No PSScriptAnalyzer errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-vmware-ui-settings/14-01-SUMMARY.md`
</output>
