---
phase: 07-feature-build-cancellation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - FFUDevelopment/BuildFFUVM.ps1
autonomous: true
user_setup: []

must_haves:
  truths:
    - "BuildFFUVM.ps1 checks for cancellation at pre-flight validation phase"
    - "BuildFFUVM.ps1 checks for cancellation before driver download"
    - "BuildFFUVM.ps1 checks for cancellation before VHDX creation"
    - "BuildFFUVM.ps1 checks for cancellation before VM start"
    - "BuildFFUVM.ps1 checks for cancellation before FFU capture"
    - "Cancellation triggers cleanup and graceful exit"
    - "Clear-CleanupRegistry called on successful completion"
  artifacts:
    - path: "FFUDevelopment/BuildFFUVM.ps1"
      provides: "Cancellation checkpoints in build script"
      contains: "Test-BuildCancellation"
  key_links:
    - from: "BuildFFUVM.ps1"
      to: "FFU.Core"
      via: "Test-BuildCancellation calls"
      pattern: "Test-BuildCancellation.*MessagingContext"
    - from: "BuildFFUVM.ps1"
      to: "FFU.Core"
      via: "Clear-CleanupRegistry on success"
      pattern: "Clear-CleanupRegistry"
---

<objective>
Add cancellation checkpoints to BuildFFUVM.ps1 at major phase boundaries, enabling graceful build termination when user clicks Cancel in UI.

Purpose: Wire the existing FFU.Messaging cancellation mechanism to BuildFFUVM.ps1's execution flow, so builds can be stopped cleanly with proper resource cleanup.

Output: BuildFFUVM.ps1 with ~8 cancellation checkpoints at phase boundaries, using Test-BuildCancellation from Plan 07-01.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-feature-build-cancellation/07-RESEARCH.md
@.planning/phases/07-feature-build-cancellation/07-01-SUMMARY.md

Key files to reference:
- FFUDevelopment/BuildFFUVM.ps1 (main build orchestrator, 4683 lines)
- FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1 (cleanup registry functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cancellation checkpoints to BuildFFUVM.ps1</name>
  <files>FFUDevelopment/BuildFFUVM.ps1</files>
  <action>
Add Test-BuildCancellation calls at the following phase boundaries in BuildFFUVM.ps1.

**Checkpoint Pattern:**
```powershell
# Check for cancellation before [PHASE]
if (Test-BuildCancellation -MessagingContext $MessagingContext -PhaseName "[PHASE_NAME]" -InvokeCleanup) {
    WriteLog "Build cancelled by user at: [PHASE_NAME]"
    return
}
```

**Checkpoint Locations (add in order):**

1. **After pre-flight validation** (~line 1717, after "Pre-flight validation passed successfully"):
   - Phase name: "Pre-flight Validation"
   - Add immediately after the preflight success log

2. **Before driver download** (~line 2300, before "Starting parallel driver processing"):
   - Phase name: "Driver Download"
   - Add before the Invoke-ParallelProcessing call for drivers

3. **Before VHDX creation** (~line 3540, before "Creating dynamic VHD" or "Creating VHDX"):
   - Phase name: "VHDX Creation"
   - Add before the VHDX creation logic

4. **After VHDX creation, before VM setup** (~line 3800, after VHDX creation succeeds):
   - Phase name: "VM Setup"
   - Add after the VHDX is created but before VM configuration

5. **Before VM start** (~line 4260, before "Starting VM"):
   - Phase name: "VM Start"
   - Add before Start-VM or vmrun start

6. **After VM shutdown, before FFU capture** (~line 4480, after VM is confirmed off):
   - Phase name: "FFU Capture"
   - Add after the VM shutdown polling completes, before DISM capture

7. **Before deployment media creation** (~line 4500, before CreateDeploymentMedia):
   - Phase name: "Deployment Media"
   - Add before deployment ISO creation

8. **Before USB drive creation** (~line 4550, before BuildUSBDrive):
   - Phase name: "USB Drive Creation"
   - Add before USB partitioning/copying

**IMPORTANT:**
- All checkpoints use `-InvokeCleanup` switch to trigger cleanup and state change
- All checkpoints `return` immediately after cancellation detected
- Checkpoints should NOT be inside try blocks that would catch the return
- Log the phase name for debugging
  </action>
  <verify>
Search BuildFFUVM.ps1 for cancellation checkpoints:
`Select-String -Path FFUDevelopment/BuildFFUVM.ps1 -Pattern "Test-BuildCancellation" | Measure-Object`
Should return count >= 8
  </verify>
  <done>BuildFFUVM.ps1 contains at least 8 Test-BuildCancellation calls at major phase boundaries</done>
</task>

<task type="auto">
  <name>Task 2: Add cleanup registry finalization on successful completion</name>
  <files>FFUDevelopment/BuildFFUVM.ps1</files>
  <action>
At the END of BuildFFUVM.ps1's successful execution path (after all operations complete successfully, before final success log):

1. Find the final success log message (search for "FFU creation complete" or similar at end of script)

2. Add before the final success message:
```powershell
# Clear cleanup registry - build completed successfully
Clear-CleanupRegistry
WriteLog "Cleanup registry cleared after successful build completion"
```

3. Verify the script's error handling path:
   - In the main try/catch block, ensure Invoke-FailureCleanup is called in catch
   - If no main try/catch exists, document this as a limitation

**Location guidance:**
The script likely ends around line 4650-4680. Look for:
- Final WriteLog with success message
- Exit code or completion indicator
- End of PROCESS block
  </action>
  <verify>
`Select-String -Path FFUDevelopment/BuildFFUVM.ps1 -Pattern "Clear-CleanupRegistry"`
Should find at least 1 occurrence near end of script.
  </verify>
  <done>Clear-CleanupRegistry called at end of successful build, ensuring no orphaned cleanup actions</done>
</task>

<task type="auto">
  <name>Task 3: Verify resource cleanup registration coverage</name>
  <files>FFUDevelopment/BuildFFUVM.ps1</files>
  <action>
Audit BuildFFUVM.ps1 for resource creation points and verify Register-*Cleanup calls exist:

**Resources to verify (search for these patterns):**

1. **VM Creation** - Search: `New-FFUVM`, `New-VM`
   - Must have corresponding `Register-VMCleanup -VMName $VMName`
   - Should be immediately after VM creation succeeds

2. **VHDX Creation** - Search: `New-VHD`, `diskpart`
   - Must have corresponding `Register-VHDXCleanup -VHDXPath $VHDXPath`
   - Should be immediately after VHDX creation succeeds

3. **DISM Mounts** - Search: `Mount-WindowsImage`, `Invoke-WimMountWithErrorHandling`
   - Must have corresponding `Register-DISMMountCleanup -MountPath $mountPath`
   - Should be immediately after mount succeeds

4. **Network Shares** - Search: `New-SmbShare`, `net share`
   - Must have corresponding `Register-NetworkShareCleanup` if created
   - This may not exist yet - add if shares are created

5. **User Accounts** - Search: `New-LocalUser`, FFUUser
   - Must have corresponding `Register-UserAccountCleanup` if created
   - Check if temporary user accounts are created for capture

6. **ISO Creation** - Search: `oscdimg`, `New-Item.*\.iso`
   - May need `Register-ISOCleanup` or `Register-TempFileCleanup`

**For each resource type:**
- If Register-*Cleanup exists immediately after creation: PASS
- If Register-*Cleanup is missing: ADD IT

**Output:**
Create a comment block at top of relevant section documenting cleanup coverage:
```powershell
# CLEANUP COVERAGE NOTE: VM, VHDX, DISM mounts are registered for cleanup
# automatically after creation. Cancellation will invoke LIFO cleanup.
```
  </action>
  <verify>
`Select-String -Path FFUDevelopment/BuildFFUVM.ps1 -Pattern "Register-.*Cleanup" | Measure-Object`
Count should be >= 3 (at minimum: VM, VHDX, DISM mount)
  </verify>
  <done>All major resources (VM, VHDX, DISM mounts) have Register-*Cleanup calls after creation</done>
</task>

</tasks>

<verification>
1. Cancellation checkpoints exist: `(Select-String -Path FFUDevelopment/BuildFFUVM.ps1 -Pattern "Test-BuildCancellation").Count -ge 8`
2. Cleanup finalization exists: `Select-String -Path FFUDevelopment/BuildFFUVM.ps1 -Pattern "Clear-CleanupRegistry"`
3. Resource registration exists: `(Select-String -Path FFUDevelopment/BuildFFUVM.ps1 -Pattern "Register-.*Cleanup").Count -ge 3`
4. Script still parses: `[scriptblock]::Create((Get-Content FFUDevelopment/BuildFFUVM.ps1 -Raw))` does not throw
</verification>

<success_criteria>
- BuildFFUVM.ps1 contains 8+ cancellation checkpoints at phase boundaries
- Clear-CleanupRegistry called at end of successful build
- VM, VHDX, and DISM mount resources have Register-*Cleanup calls
- Script parses without syntax errors
- Checkpoints use consistent pattern with -InvokeCleanup switch
</success_criteria>

<output>
After completion, create `.planning/phases/07-feature-build-cancellation/07-02-SUMMARY.md`
</output>
