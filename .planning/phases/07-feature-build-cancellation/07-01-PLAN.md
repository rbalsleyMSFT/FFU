---
phase: 07-feature-build-cancellation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1
  - FFUDevelopment/Modules/FFU.Core/FFU.Core.psd1
  - Tests/Unit/FFU.Core.BuildCancellation.Tests.ps1
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Test-BuildCancellation function exists and is exported from FFU.Core"
    - "Function returns true when cancellation is requested in messaging context"
    - "Function returns false when no messaging context provided (CLI mode)"
    - "Function invokes cleanup when -InvokeCleanup specified"
    - "Function sets build state to Cancelled after cleanup"
  artifacts:
    - path: "FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1"
      provides: "Test-BuildCancellation function"
      contains: "function Test-BuildCancellation"
    - path: "FFUDevelopment/Modules/FFU.Core/FFU.Core.psd1"
      provides: "Module manifest with exported function"
      contains: "Test-BuildCancellation"
    - path: "Tests/Unit/FFU.Core.BuildCancellation.Tests.ps1"
      provides: "Unit tests for cancellation helper"
      min_lines: 80
  key_links:
    - from: "FFU.Core.psm1"
      to: "FFU.Messaging"
      via: "Test-FFUCancellationRequested call"
      pattern: "Test-FFUCancellationRequested"
    - from: "FFU.Core.psm1"
      to: "Invoke-FailureCleanup"
      via: "Cleanup invocation"
      pattern: "Invoke-FailureCleanup"
---

<objective>
Add Test-BuildCancellation helper function to FFU.Core module for consistent cancellation checking at build phase boundaries.

Purpose: Provides a single function that BuildFFUVM.ps1 can call at phase boundaries to check for user cancellation and trigger cleanup. This encapsulates the cancellation check + logging + cleanup invocation pattern.

Output: FFU.Core module exports Test-BuildCancellation, with Pester tests verifying all scenarios.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-feature-build-cancellation/07-RESEARCH.md

Key files to reference:
- FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1 (lines 2165-2395 for cleanup registry)
- FFUDevelopment/Modules/FFU.Messaging/FFU.Messaging.psm1 (lines 762-771 for Test-FFUCancellationRequested)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Test-BuildCancellation function to FFU.Core</name>
  <files>FFUDevelopment/Modules/FFU.Core/FFU.Core.psm1</files>
  <action>
Add the Test-BuildCancellation function to FFU.Core.psm1 after the existing Invoke-FailureCleanup function (around line 2364).

Implementation requirements:
1. Function signature:
```powershell
function Test-BuildCancellation {
    [CmdletBinding()]
    [OutputType([bool])]
    param(
        [Parameter()]
        [hashtable]$MessagingContext,

        [Parameter(Mandatory)]
        [string]$PhaseName,

        [Parameter()]
        [switch]$InvokeCleanup
    )
```

2. Logic:
   - Return $false immediately if $MessagingContext is $null (CLI mode, no cancellation support)
   - Call Test-FFUCancellationRequested from FFU.Messaging module
   - If cancellation NOT requested, return $false
   - If cancellation requested:
     - Log "Cancellation detected at phase: $PhaseName" via WriteLog
     - Call Write-FFUWarning with message about cancellation
     - If $InvokeCleanup switch:
       - Call Invoke-FailureCleanup -Reason "User cancelled build at: $PhaseName"
       - Call Set-FFUBuildState -Context $MessagingContext -State Cancelled -SendMessage
     - Return $true

3. Add comprehensive comment-based help (.SYNOPSIS, .DESCRIPTION, .PARAMETER, .EXAMPLE, .OUTPUTS)

4. Use safe logging pattern (WriteLog if available, else Write-Verbose) consistent with other FFU.Core functions.

IMPORTANT: FFU.Messaging module must be imported for Test-FFUCancellationRequested and Write-FFUWarning. Add RequiredModules check or document that caller must have FFU.Messaging loaded.
  </action>
  <verify>
Run: `Import-Module FFUDevelopment/Modules/FFU.Core -Force; Get-Command Test-BuildCancellation`
Should show the command exists with expected parameters.
  </verify>
  <done>Test-BuildCancellation function exists in FFU.Core with all parameters and logic implemented</done>
</task>

<task type="auto">
  <name>Task 2: Update FFU.Core manifest and version</name>
  <files>FFUDevelopment/Modules/FFU.Core/FFU.Core.psd1, FFUDevelopment/version.json</files>
  <action>
1. Add 'Test-BuildCancellation' to the FunctionsToExport array in FFU.Core.psd1 (around line 65-79 in the exports section)

2. Bump module version in FFU.Core.psd1 from current version to next patch (e.g., 1.0.X+1)

3. Add ReleaseNotes entry documenting the new function:
   "- Added Test-BuildCancellation function for graceful build cancellation support"

4. Update version.json:
   - Bump main version patch number
   - Update FFU.Core module version in modules section
   - Update buildDate to current date

5. If RequiredModules does not already include FFU.Messaging, add it:
```powershell
@{ModuleName = 'FFU.Messaging'; ModuleVersion = '1.0.0'}
```
  </action>
  <verify>
Run: `Import-Module FFUDevelopment/Modules/FFU.Core -Force; (Get-Module FFU.Core).ExportedFunctions.Keys -contains 'Test-BuildCancellation'`
Should return True.
  </verify>
  <done>FFU.Core manifest exports Test-BuildCancellation, versions updated in manifest and version.json</done>
</task>

<task type="auto">
  <name>Task 3: Create Pester tests for Test-BuildCancellation</name>
  <files>Tests/Unit/FFU.Core.BuildCancellation.Tests.ps1</files>
  <action>
Create new Pester 5.x test file with comprehensive coverage:

1. Test structure:
```powershell
BeforeAll {
    # Import FFU.Messaging first (provides Test-FFUCancellationRequested)
    # Import FFU.Core
    # Mock WriteLog to prevent actual logging
}

Describe 'Test-BuildCancellation' {
    Context 'When MessagingContext is null (CLI mode)' {
        It 'Returns false without checking cancellation' { }
    }

    Context 'When cancellation is not requested' {
        BeforeEach {
            # Create mock messaging context with CancellationRequested = $false
        }
        It 'Returns false' { }
        It 'Does not call Invoke-FailureCleanup' { }
        It 'Does not change build state' { }
    }

    Context 'When cancellation is requested' {
        BeforeEach {
            # Create mock messaging context with CancellationRequested = $true
        }
        It 'Returns true' { }
        It 'Logs cancellation detected message' { }

        Context 'Without -InvokeCleanup switch' {
            It 'Does not call Invoke-FailureCleanup' { }
            It 'Does not set build state to Cancelled' { }
        }

        Context 'With -InvokeCleanup switch' {
            It 'Calls Invoke-FailureCleanup with correct reason' { }
            It 'Sets build state to Cancelled' { }
        }
    }

    Context 'Phase name handling' {
        It 'Includes phase name in log message' { }
        It 'Includes phase name in cleanup reason' { }
    }
}
```

2. Use InModuleScope for accessing internal behavior if needed

3. Mock Test-FFUCancellationRequested to control return value

4. Mock Invoke-FailureCleanup to verify it's called with correct parameters

5. Mock Set-FFUBuildState to verify state transitions

6. Verify logging behavior with Assert-MockCalled on WriteLog

Target: 15-20 test cases covering all branches
  </action>
  <verify>
Run: `Invoke-Pester Tests/Unit/FFU.Core.BuildCancellation.Tests.ps1 -Output Detailed`
All tests should pass.
  </verify>
  <done>Pester test file exists with 15+ passing tests covering all Test-BuildCancellation scenarios</done>
</task>

</tasks>

<verification>
1. Module imports successfully: `Import-Module FFUDevelopment/Modules/FFU.Core -Force`
2. Function is exported: `Get-Command Test-BuildCancellation -Module FFU.Core`
3. All Pester tests pass: `Invoke-Pester Tests/Unit/FFU.Core.BuildCancellation.Tests.ps1`
4. Function returns false with null context: `Test-BuildCancellation -MessagingContext $null -PhaseName "Test"` returns False
</verification>

<success_criteria>
- Test-BuildCancellation function added to FFU.Core.psm1 with full implementation
- Function exported in FFU.Core.psd1 manifest
- Module version bumped in both .psd1 and version.json
- Pester tests pass with 100% coverage of function branches
- Function correctly handles: null context, no cancellation, cancellation without cleanup, cancellation with cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/07-feature-build-cancellation/07-01-SUMMARY.md`
</output>
