---
phase: 09-feature-config-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FFUDevelopment/config/ffubuilder-config.schema.json
  - FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1
  - FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1
autonomous: true

must_haves:
  truths:
    - "Config schema includes configSchemaVersion property"
    - "Migration function transforms deprecated properties to modern equivalents"
    - "Version check determines if migration is needed"
    - "Backup created before migration modifies config"
  artifacts:
    - path: "FFUDevelopment/config/ffubuilder-config.schema.json"
      provides: "configSchemaVersion property definition"
      contains: "configSchemaVersion"
    - path: "FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1"
      provides: "Module manifest"
      exports: ["Invoke-FFUConfigMigration", "Test-FFUConfigVersion", "Get-FFUConfigSchemaVersion"]
    - path: "FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1"
      provides: "Migration logic implementation"
      min_lines: 150
  key_links:
    - from: "FFU.ConfigMigration"
      to: "FFU.Checkpoint"
      via: "ConvertTo-HashtableRecursive import"
      pattern: "ConvertTo-HashtableRecursive"
---

<objective>
Create FFU.ConfigMigration module with schema version support and migration functions.

Purpose: Enable automatic detection and migration of older config files to current schema format, preserving user customizations while removing deprecated properties.

Output:
- Updated schema with configSchemaVersion field
- FFU.ConfigMigration module with core migration functions
- Transformation logic for 7 deprecated properties
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-feature-config-migration/09-RESEARCH.md

# Existing patterns
@FFUDevelopment/config/ffubuilder-config.schema.json
@FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psm1
@FFUDevelopment/Modules/FFU.Checkpoint/FFU.Checkpoint.psd1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configSchemaVersion to JSON Schema</name>
  <files>FFUDevelopment/config/ffubuilder-config.schema.json</files>
  <action>
Add `configSchemaVersion` property to the schema after the `_comment` property:

```json
"configSchemaVersion": {
    "type": "string",
    "pattern": "^[0-9]+\\.[0-9]+$",
    "default": "1.0",
    "description": "Schema version of this configuration file. Used for automatic migration of older configs. Configs without this field are treated as version 0.0 (pre-versioning)."
}
```

This property:
- Uses major.minor format (e.g., "1.0", "1.1", "2.0")
- Pattern validates format
- Default is "1.0" (current schema version)
- Pre-versioning configs treated as "0.0"
  </action>
  <verify>
Validate JSON syntax: `Get-Content FFUDevelopment/config/ffubuilder-config.schema.json | ConvertFrom-Json`
Verify property exists: Schema contains "configSchemaVersion" with correct type and pattern
  </verify>
  <done>
Schema has configSchemaVersion property with string type, version pattern, and default "1.0"
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FFU.ConfigMigration Module</name>
  <files>
FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1
FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psm1
  </files>
  <action>
Create new module directory: `FFUDevelopment/Modules/FFU.ConfigMigration/`

**FFU.ConfigMigration.psd1:**
- ModuleVersion = '1.0.0'
- GUID = (generate new GUID)
- Author = 'FFU Builder Team'
- Description = 'Configuration file migration for FFU Builder'
- RequiredModules = @(@{ModuleName = 'FFU.Checkpoint'; ModuleVersion = '1.0.0'})
- FunctionsToExport = @('Invoke-FFUConfigMigration', 'Test-FFUConfigVersion', 'Get-FFUConfigSchemaVersion', 'ConvertTo-HashtableRecursive')
- ReleaseNotes = 'Initial release: Config schema versioning and migration support'

**FFU.ConfigMigration.psm1:**

Implement these functions:

1. **Get-FFUConfigSchemaVersion** - Returns current schema version ("1.0")
   - No parameters
   - Returns [string] "1.0"
   - Single source of truth for version

2. **Test-FFUConfigVersion** - Checks if config needs migration
   - Parameters: -ConfigPath (file) OR -Config (hashtable), -CurrentSchemaVersion (optional, defaults to Get-FFUConfigSchemaVersion)
   - Uses ConvertTo-HashtableRecursive from FFU.Checkpoint for PS5.1 compatibility
   - Returns [PSCustomObject] with ConfigVersion, CurrentSchemaVersion, NeedsMigration, VersionDifference
   - Pre-versioning configs (no configSchemaVersion) treated as "0.0"
   - Uses [System.Version]::Parse() for proper comparison (1.0 < 1.10)

3. **ConvertTo-HashtableRecursive** - Re-export from FFU.Checkpoint for convenience
   - Import and re-export for users who don't want FFU.Checkpoint dependency
   - Same implementation as FFU.Checkpoint (lines 104-157)

4. **Invoke-FFUConfigMigration** - Main migration function
   - Parameters:
     - -Config [hashtable] (Mandatory) - Config to migrate
     - -TargetVersion [string] (optional, defaults to Get-FFUConfigSchemaVersion)
     - -CreateBackup [switch] - Create backup before migration
     - -ConfigPath [string] - Path for backup creation
   - Returns [hashtable] with:
     - Config: Migrated config hashtable
     - Changes: Array of change descriptions
     - FromVersion: Original version
     - ToVersion: Target version
     - BackupPath: Path to backup (if created)

**Migration Logic (from research):**

```powershell
# Handle deprecated properties:
# 1. AppsPath, OfficePath - Remove (computed from FFUDevelopmentPath)
# 2. Verbose - Remove (use CLI -Verbose switch)
# 3. Threads - Remove (automatic parallel processing)
# 4. InstallWingetApps -> InstallApps (if true, set InstallApps=true)
# 5. DownloadDrivers - Remove with warning (requires Make/Model)
# 6. CopyOfficeConfigXML - Remove with warning (requires OfficeConfigXMLFile)

# Preserve unknown properties for forward compatibility
# Set configSchemaVersion = TargetVersion
# Log all changes via WriteLog if available
```

**Important patterns:**
- Use `$script:CurrentConfigSchemaVersion = "1.0"` for version constant
- Start with hashtable clone to preserve unknown properties
- Distinguish between "removed" (no replacement) and "migrated" (transformed) properties
- WARNING prefix for changes requiring user action (DownloadDrivers, CopyOfficeConfigXML)
- Backup uses timestamp suffix: `.backup-yyyyMMdd-HHmmss`
  </action>
  <verify>
Module imports: `Import-Module FFUDevelopment/Modules/FFU.ConfigMigration -Force`
Function exports: `Get-Command -Module FFU.ConfigMigration` shows 4 functions
Version check: `Get-FFUConfigSchemaVersion` returns "1.0"
  </verify>
  <done>
FFU.ConfigMigration module exists with:
- Get-FFUConfigSchemaVersion returns "1.0"
- Test-FFUConfigVersion detects pre-versioning configs
- Invoke-FFUConfigMigration transforms deprecated properties
- ConvertTo-HashtableRecursive available for PS5.1 compatibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Migration Module Pester Tests</name>
  <files>Tests/Unit/FFU.ConfigMigration.Tests.ps1</files>
  <action>
Create comprehensive Pester 5.x tests for FFU.ConfigMigration module.

**Test Categories:**

1. **Get-FFUConfigSchemaVersion Tests**
   - Returns string type
   - Returns "1.0" (current version)

2. **Test-FFUConfigVersion Tests**
   - Pre-versioning config (no configSchemaVersion) returns NeedsMigration=$true, ConfigVersion="0.0"
   - Current version config returns NeedsMigration=$false
   - Older version config returns NeedsMigration=$true
   - Newer version config returns NeedsMigration=$false (forward compatible)
   - Parameter validation (ConfigPath must exist if used)

3. **ConvertTo-HashtableRecursive Tests**
   - Null input returns null
   - Primitive values returned as-is
   - PSCustomObject converted to hashtable
   - Nested PSCustomObject converted recursively
   - Arrays processed element-by-element

4. **Invoke-FFUConfigMigration Tests**
   - Already at target version returns unchanged config
   - AppsPath removed from migrated config
   - OfficePath removed from migrated config
   - Verbose removed from migrated config
   - Threads removed from migrated config
   - InstallWingetApps=true becomes InstallApps=true
   - DownloadDrivers=true adds warning about Make/Model
   - CopyOfficeConfigXML=true adds warning about OfficeConfigXMLFile
   - Unknown properties preserved (forward compatibility)
   - configSchemaVersion set to TargetVersion
   - Changes array contains descriptions
   - CreateBackup creates file with timestamp suffix
   - BackupPath returned when backup created

**Test data patterns:**
```powershell
$preVersionConfig = @{
    FFUDevelopmentPath = 'C:\FFU'
    AppsPath = 'C:\FFU\Apps'
    Verbose = $true
    InstallWingetApps = $true
}

$currentVersionConfig = @{
    configSchemaVersion = '1.0'
    FFUDevelopmentPath = 'C:\FFU'
    InstallApps = $true
}
```

Follow existing test patterns from FFU.Checkpoint.Tests.ps1.
  </action>
  <verify>
Run tests: `Invoke-Pester -Path Tests/Unit/FFU.ConfigMigration.Tests.ps1 -Output Detailed`
All tests pass, minimum 20 test cases covering all functions
  </verify>
  <done>
FFU.ConfigMigration.Tests.ps1 exists with comprehensive test coverage:
- All 4 exported functions tested
- Edge cases for version detection
- All 7 deprecated property migrations tested
- Forward compatibility verified
- Backup functionality tested
  </done>
</task>

</tasks>

<verification>
1. Schema validation: `Get-Content FFUDevelopment/config/ffubuilder-config.schema.json | ConvertFrom-Json` succeeds
2. Module imports cleanly: `Import-Module FFUDevelopment/Modules/FFU.ConfigMigration -Force -ErrorAction Stop`
3. All functions exported: `(Get-Command -Module FFU.ConfigMigration).Count -eq 4`
4. Tests pass: `Invoke-Pester Tests/Unit/FFU.ConfigMigration.Tests.ps1 -PassThru | % { $_.FailedCount -eq 0 }`
</verification>

<success_criteria>
- configSchemaVersion property exists in schema with default "1.0"
- FFU.ConfigMigration module exports 4 functions
- Get-FFUConfigSchemaVersion returns "1.0"
- Test-FFUConfigVersion correctly identifies pre-versioning configs
- Invoke-FFUConfigMigration transforms all 7 deprecated properties
- All Pester tests pass (minimum 20 test cases)
</success_criteria>

<output>
After completion, create `.planning/phases/09-feature-config-migration/09-01-SUMMARY.md`
</output>
