---
phase: 09-feature-config-migration
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1
  - FFUDevelopment/BuildFFUVM.ps1
autonomous: true

must_haves:
  truths:
    - "UI auto-load triggers migration for pre-versioning configs"
    - "CLI config loading triggers migration with user prompt"
    - "User sees migration changes before they are applied"
    - "Migrated config saved to disk after user confirmation"
  artifacts:
    - path: "FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1"
      provides: "UI migration integration"
      contains: "Invoke-FFUConfigMigration"
    - path: "FFUDevelopment/BuildFFUVM.ps1"
      provides: "CLI migration integration"
      contains: "Invoke-FFUConfigMigration"
  key_links:
    - from: "FFUUI.Core.Config.psm1"
      to: "FFU.ConfigMigration"
      via: "Import-Module and function call"
      pattern: "Invoke-FFUConfigMigration"
    - from: "BuildFFUVM.ps1"
      to: "FFU.ConfigMigration"
      via: "Import-Module and function call"
      pattern: "Invoke-FFUConfigMigration"
---

<objective>
Integrate config migration into UI and CLI config loading flows.

Purpose: Ensure users are prompted when loading older config files and can choose to migrate them, with clear feedback about what changes will be applied.

Output:
- FFUUI.Core.Config.psm1 updated with migration dialog
- BuildFFUVM.ps1 updated with CLI migration prompt
- Migrated configs automatically saved after user confirmation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-feature-config-migration/09-01-SUMMARY.md

# Integration points
@FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1
@FFUDevelopment/BuildFFUVM.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate Migration into UI Auto-Load</name>
  <files>FFUDevelopment/FFUUI.Core/FFUUI.Core.Config.psm1</files>
  <action>
Modify `Invoke-AutoLoadPreviousEnvironment` function (around line 914) to check for and apply config migration.

**Changes:**

1. **Import FFU.ConfigMigration at module load** (add near top of file after other imports):
```powershell
# Import config migration module
$migrationModulePath = Join-Path (Split-Path $PSScriptRoot -Parent) 'Modules\FFU.ConfigMigration'
if (Test-Path $migrationModulePath) {
    Import-Module (Join-Path $migrationModulePath 'FFU.ConfigMigration.psd1') -Force -ErrorAction SilentlyContinue
}
```

2. **Add Show-ConfigMigrationDialog helper function** (before Invoke-AutoLoadPreviousEnvironment):
```powershell
function Show-ConfigMigrationDialog {
    <#
    .SYNOPSIS
    Shows a dialog with migration changes and asks user to confirm.
    #>
    [CmdletBinding()]
    [OutputType([bool])]
    param(
        [Parameter(Mandatory)]
        [hashtable]$MigrationResult
    )

    if ($MigrationResult.Changes.Count -eq 0) {
        return $true  # No changes needed
    }

    # Format changes with icons
    $changesList = $MigrationResult.Changes | ForEach-Object {
        if ($_ -like "WARNING:*") {
            "[!] $_"
        } else {
            "[+] $_"
        }
    }
    $changesText = $changesList -join "`n"

    $message = @"
Your configuration file was created with an older version of FFU Builder.

From version: $($MigrationResult.FromVersion)
To version: $($MigrationResult.ToVersion)

The following changes will be applied:
$changesText

A backup of your original configuration has been created.

Do you want to apply these changes?
"@

    $result = [System.Windows.MessageBox]::Show(
        $message,
        "Configuration Migration Required",
        [System.Windows.MessageBoxButton]::YesNo,
        [System.Windows.MessageBoxImage]::Question
    )

    return ($result -eq [System.Windows.MessageBoxResult]::Yes)
}
```

3. **Modify Invoke-AutoLoadPreviousEnvironment** (after JSON parse, before Update-UIFromConfig):

After line ~944 (`if ($null -eq $configContent) { ... }`), add migration check:

```powershell
# Check if migration is needed
if (Get-Command -Name 'Test-FFUConfigVersion' -ErrorAction SilentlyContinue) {
    # Convert to hashtable for migration
    $configHashtable = ConvertTo-HashtableRecursive -InputObject $configContent

    $versionCheck = Test-FFUConfigVersion -Config $configHashtable

    if ($versionCheck.NeedsMigration) {
        WriteLog "AutoLoad: Config needs migration from v$($versionCheck.ConfigVersion) to v$($versionCheck.CurrentSchemaVersion)"

        # Perform migration with backup
        $migrationResult = Invoke-FFUConfigMigration -Config $configHashtable -CreateBackup -ConfigPath $configPath

        if ($migrationResult.Changes.Count -gt 0) {
            # Show dialog and get user confirmation
            $proceed = Show-ConfigMigrationDialog -MigrationResult $migrationResult

            if ($proceed) {
                WriteLog "AutoLoad: User accepted migration. Saving migrated config."

                # Save migrated config
                $migrationResult.Config | ConvertTo-Json -Depth 10 | Set-Content -Path $configPath -Encoding UTF8
                WriteLog "AutoLoad: Migrated config saved to $configPath"

                # Use migrated config
                $configContent = [PSCustomObject]$migrationResult.Config
            } else {
                WriteLog "AutoLoad: User declined migration. Loading original config (deprecated properties ignored)."
            }
        }
    }
}
```

**Important:**
- Migration happens BEFORE Update-UIFromConfig
- Backup created automatically before showing dialog
- If user declines, original config still loaded (deprecated properties already ignored)
- WriteLog used for all operations (visible in Monitor tab)
  </action>
  <verify>
- File compiles: `Import-Module FFUDevelopment/FFUUI.Core -Force`
- Functions exist: `Get-Command -Module FFUUI.Core.Config` includes Show-ConfigMigrationDialog
- Migration module imported: Confirm Import-Module statement added
  </verify>
  <done>
FFUUI.Core.Config.psm1 contains:
- Show-ConfigMigrationDialog function with WPF MessageBox
- Invoke-AutoLoadPreviousEnvironment checks for migration
- Migrated config saved after user confirmation
- Backup created before migration
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Migration into CLI Config Loading</name>
  <files>FFUDevelopment/BuildFFUVM.ps1</files>
  <action>
Modify the config loading section in BuildFFUVM.ps1 (around lines 710-746) to check for and apply config migration.

**Changes:**

1. **Import FFU.ConfigMigration module** (add after other module imports, around line 690):
```powershell
# Import config migration module for version handling
$migrationModulePath = Join-Path $ModulePath 'FFU.ConfigMigration'
if (Test-Path $migrationModulePath) {
    Import-Module (Join-Path $migrationModulePath 'FFU.ConfigMigration.psd1') -Force -ErrorAction SilentlyContinue
}
```

2. **Add migration check after loading config** (modify lines 710-746):

Replace the current config loading block with:

```powershell
# If a config file is specified and it exists, load it
if ($ConfigFile -and (Test-Path -Path $ConfigFile)) {
    $configData = Get-Content $ConfigFile -Raw | ConvertFrom-Json

    # Check for migration if module available
    if (Get-Command -Name 'Test-FFUConfigVersion' -ErrorAction SilentlyContinue) {
        # Convert to hashtable for migration
        $configHashtable = ConvertTo-HashtableRecursive -InputObject $configData

        $versionCheck = Test-FFUConfigVersion -Config $configHashtable

        if ($versionCheck.NeedsMigration) {
            WriteLog "Config needs migration from v$($versionCheck.ConfigVersion) to v$($versionCheck.CurrentSchemaVersion)"

            # Perform migration with backup
            $migrationResult = Invoke-FFUConfigMigration -Config $configHashtable -CreateBackup -ConfigPath $ConfigFile

            if ($migrationResult.Changes.Count -gt 0) {
                WriteLog "Migration changes detected:"
                foreach ($change in $migrationResult.Changes) {
                    WriteLog "  - $change"
                }
                WriteLog "Backup created: $($migrationResult.BackupPath)"

                # CLI prompt for confirmation
                Write-Host ""
                Write-Host "Your configuration file needs migration from v$($migrationResult.FromVersion) to v$($migrationResult.ToVersion)." -ForegroundColor Yellow
                Write-Host "Changes to be applied:" -ForegroundColor Yellow
                foreach ($change in $migrationResult.Changes) {
                    if ($change -like "WARNING:*") {
                        Write-Host "  [!] $change" -ForegroundColor Red
                    } else {
                        Write-Host "  [+] $change" -ForegroundColor Green
                    }
                }
                Write-Host ""
                Write-Host "Backup created at: $($migrationResult.BackupPath)" -ForegroundColor Cyan
                Write-Host ""

                $response = Read-Host "Save migrated configuration? (Y/N)"

                if ($response -eq 'Y' -or $response -eq 'y') {
                    $migrationResult.Config | ConvertTo-Json -Depth 10 | Set-Content -Path $ConfigFile -Encoding UTF8
                    WriteLog "Migrated configuration saved to $ConfigFile"
                    Write-Host "Configuration migrated and saved." -ForegroundColor Green

                    # Use migrated config
                    $configData = [PSCustomObject]$migrationResult.Config
                } else {
                    WriteLog "User declined migration. Continuing with original config (deprecated properties ignored)."
                    Write-Host "Migration declined. Continuing with original configuration." -ForegroundColor Yellow
                }
            }
        }
    }

    # Process config keys (existing logic)
    $keys = $configData.psobject.Properties.Name

    # ... rest of existing key iteration logic unchanged ...
```

**Important patterns:**
- Check for module availability with `Get-Command` (graceful fallback if not installed)
- Use Write-Host for CLI prompts (with colors) - this is appropriate for interactive CLI
- WriteLog for operations (captured in log file)
- Read-Host for Y/N prompt
- If migration declined, original config still loaded (deprecated properties already ignored by existing logic)
  </action>
  <verify>
- Script parses: `Get-Content FFUDevelopment/BuildFFUVM.ps1 | Out-Null` (no parse errors)
- Migration module import exists: Search for "FFU.ConfigMigration" in file
- Read-Host prompt exists: Search for "Save migrated configuration"
  </verify>
  <done>
BuildFFUVM.ps1 contains:
- FFU.ConfigMigration module import (with graceful fallback)
- Version check after config load
- CLI prompt showing changes with colors
- Backup path displayed to user
- Y/N prompt to save migrated config
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Module Load Order Documentation</name>
  <files>FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1</files>
  <action>
Update the FFU.ConfigMigration.psd1 manifest to ensure proper load order and document the module's role.

**Updates:**

1. Verify RequiredModules includes FFU.Checkpoint:
```powershell
RequiredModules = @(
    @{ModuleName = 'FFU.Checkpoint'; ModuleVersion = '1.0.0'}
)
```

2. Add PrivateData with PSData for description:
```powershell
PrivateData = @{
    PSData = @{
        Tags = @('Configuration', 'Migration', 'FFUBuilder')
        ProjectUri = 'https://github.com/rbalsleyMSFT/FFU'
        ReleaseNotes = @'
v1.0.0 - Initial release
- Config schema versioning with configSchemaVersion field
- Migration functions for 7 deprecated properties
- UI and CLI integration support
- Backup creation before migration
'@
    }
}
```

3. Add HelpInfoURI (optional but good practice):
```powershell
HelpInfoURI = 'https://github.com/rbalsleyMSFT/FFU/wiki/Config-Migration'
```

This ensures:
- Module loads FFU.Checkpoint first (for ConvertTo-HashtableRecursive)
- Clear documentation of purpose and changes
- Proper metadata for module discovery
  </action>
  <verify>
- Manifest valid: `Test-ModuleManifest FFUDevelopment/Modules/FFU.ConfigMigration/FFU.ConfigMigration.psd1`
- RequiredModules present: Manifest includes FFU.Checkpoint
  </verify>
  <done>
FFU.ConfigMigration.psd1 has:
- RequiredModules with FFU.Checkpoint dependency
- PrivateData.PSData with release notes
- Proper module metadata
  </done>
</task>

</tasks>

<verification>
1. UI module loads: `Import-Module FFUDevelopment/FFUUI.Core -Force`
2. CLI script parses: `Get-Content FFUDevelopment/BuildFFUVM.ps1 | Out-Null`
3. Migration module loads with dependencies: `Import-Module FFUDevelopment/Modules/FFU.ConfigMigration -Force`
4. Integration points exist:
   - FFUUI.Core.Config.psm1 contains "Invoke-FFUConfigMigration"
   - BuildFFUVM.ps1 contains "Invoke-FFUConfigMigration"
</verification>

<success_criteria>
- Show-ConfigMigrationDialog function exists in FFUUI.Core.Config
- Invoke-AutoLoadPreviousEnvironment checks config version
- BuildFFUVM.ps1 prompts for migration with Y/N
- Both paths create backup before migration
- User sees changes before confirmation
- Migrated config saved to disk after confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/09-feature-config-migration/09-02-SUMMARY.md`
</output>
