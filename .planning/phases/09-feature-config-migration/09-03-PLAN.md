---
phase: 09-feature-config-migration
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - Tests/Unit/FFU.ConfigMigration.Integration.Tests.ps1
  - FFUDevelopment/version.json
autonomous: true

must_haves:
  truths:
    - "Integration tests verify UI migration dialog flow"
    - "Integration tests verify CLI migration prompt flow"
    - "End-to-end test migrates real config file"
    - "Version.json updated with new module"
  artifacts:
    - path: "Tests/Unit/FFU.ConfigMigration.Integration.Tests.ps1"
      provides: "Integration test coverage"
      min_lines: 100
    - path: "FFUDevelopment/version.json"
      provides: "Version tracking"
      contains: "FFU.ConfigMigration"
  key_links:
    - from: "Tests/Unit/FFU.ConfigMigration.Integration.Tests.ps1"
      to: "FFUUI.Core.Config.psm1"
      via: "Show-ConfigMigrationDialog mock/test"
      pattern: "Show-ConfigMigrationDialog"
---

<objective>
Add integration tests for config migration and update version tracking.

Purpose: Ensure migration flows work correctly in both UI and CLI contexts, with proper test coverage for edge cases and error handling.

Output:
- Integration test file with UI and CLI migration flow tests
- Updated version.json with FFU.ConfigMigration module
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-feature-config-migration/09-01-SUMMARY.md

# Test patterns
@Tests/Unit/FFU.Checkpoint.Tests.ps1
@FFUDevelopment/version.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Integration Tests for Config Migration</name>
  <files>Tests/Unit/FFU.ConfigMigration.Integration.Tests.ps1</files>
  <action>
Create integration tests that verify the complete migration flow works correctly.

**Test Categories:**

1. **End-to-End Migration Tests**
   - Pre-versioning config file migrates to current version
   - Backup file created with correct timestamp format
   - Migrated config file has configSchemaVersion set
   - All deprecated properties removed from migrated file
   - Unknown properties preserved in migrated file
   - InstallWingetApps correctly transformed to InstallApps

2. **UI Flow Tests (Mock WPF)**
   - Show-ConfigMigrationDialog returns true for accept
   - Show-ConfigMigrationDialog returns false for decline
   - Dialog message contains version numbers
   - Dialog message contains change descriptions
   - WARNING changes formatted with [!] prefix

3. **CLI Flow Tests (Mock Read-Host)**
   - Y response saves migrated config
   - N response skips save
   - Change list displayed with colors
   - Backup path displayed to user

4. **Error Handling Tests**
   - Invalid JSON config handled gracefully
   - Read-only config file fails gracefully
   - Missing backup directory created
   - Module not installed returns graceful fallback

5. **Version Comparison Tests**
   - Version 0.0 < 1.0 (pre-versioning needs migration)
   - Version 1.0 = 1.0 (current, no migration)
   - Version 1.1 > 1.0 (future, no migration - forward compatible)
   - Version 1.10 > 1.9 (semantic comparison works)

**Test Implementation Pattern:**

```powershell
BeforeAll {
    $testRoot = Split-Path $PSScriptRoot -Parent | Split-Path -Parent
    $ffuDevPath = Join-Path $testRoot 'FFUDevelopment'

    # Import migration module
    Import-Module (Join-Path $ffuDevPath 'Modules\FFU.ConfigMigration\FFU.ConfigMigration.psd1') -Force

    # Test data directory
    $script:TestDataDir = Join-Path $TestDrive 'ConfigMigrationTests'
    New-Item -Path $script:TestDataDir -ItemType Directory -Force | Out-Null
}

Describe 'Config Migration Integration Tests' {

    Context 'End-to-End Migration' {

        It 'Migrates pre-versioning config file successfully' {
            # Arrange: Create test config without version
            $testConfig = @{
                FFUDevelopmentPath = 'C:\FFU'
                AppsPath = 'C:\FFU\Apps'
                OfficePath = 'C:\FFU\Office'
                Verbose = $true
                InstallWingetApps = $true
                WindowsRelease = 11
            }
            $configPath = Join-Path $script:TestDataDir 'test-config.json'
            $testConfig | ConvertTo-Json | Set-Content -Path $configPath

            # Act: Migrate
            $configHashtable = Get-Content $configPath -Raw | ConvertFrom-Json | ConvertTo-HashtableRecursive
            $result = Invoke-FFUConfigMigration -Config $configHashtable -CreateBackup -ConfigPath $configPath

            # Assert
            $result.Config.configSchemaVersion | Should -Be '1.0'
            $result.Config.ContainsKey('AppsPath') | Should -BeFalse
            $result.Config.ContainsKey('OfficePath') | Should -BeFalse
            $result.Config.ContainsKey('Verbose') | Should -BeFalse
            $result.Config.InstallApps | Should -BeTrue
            $result.Config.FFUDevelopmentPath | Should -Be 'C:\FFU'
            $result.BackupPath | Should -Not -BeNullOrEmpty
            Test-Path $result.BackupPath | Should -BeTrue
        }

        It 'Preserves unknown properties for forward compatibility' {
            # Arrange: Config with unknown future property
            $testConfig = @{
                FFUDevelopmentPath = 'C:\FFU'
                FutureProperty = 'some-value'
                AnotherUnknown = 123
            }

            # Act
            $result = Invoke-FFUConfigMigration -Config $testConfig

            # Assert
            $result.Config.FutureProperty | Should -Be 'some-value'
            $result.Config.AnotherUnknown | Should -Be 123
        }
    }

    Context 'Version Comparison' {

        It 'Pre-versioning config needs migration (0.0 < 1.0)' {
            $config = @{ FFUDevelopmentPath = 'C:\FFU' }
            $result = Test-FFUConfigVersion -Config $config
            $result.ConfigVersion | Should -Be '0.0'
            $result.NeedsMigration | Should -BeTrue
        }

        It 'Current version config does not need migration (1.0 = 1.0)' {
            $config = @{ configSchemaVersion = '1.0'; FFUDevelopmentPath = 'C:\FFU' }
            $result = Test-FFUConfigVersion -Config $config
            $result.NeedsMigration | Should -BeFalse
        }

        It 'Future version config does not need migration (forward compatible)' {
            $config = @{ configSchemaVersion = '2.0'; FFUDevelopmentPath = 'C:\FFU' }
            $result = Test-FFUConfigVersion -Config $config
            $result.NeedsMigration | Should -BeFalse
        }

        It 'Semantic versioning works correctly (1.10 > 1.9)' {
            $config = @{ configSchemaVersion = '1.9'; FFUDevelopmentPath = 'C:\FFU' }
            $result = Test-FFUConfigVersion -Config $config -CurrentSchemaVersion '1.10'
            $result.NeedsMigration | Should -BeTrue
        }
    }

    Context 'Deprecated Property Migrations' {

        It 'Removes AppsPath (computed dynamically)' {
            $config = @{ AppsPath = 'C:\Custom\Apps' }
            $result = Invoke-FFUConfigMigration -Config $config
            $result.Config.ContainsKey('AppsPath') | Should -BeFalse
            $result.Changes | Should -Contain "Removed deprecated property 'AppsPath' (now computed from FFUDevelopmentPath)"
        }

        # Similar tests for OfficePath, Verbose, Threads, InstallWingetApps, DownloadDrivers, CopyOfficeConfigXML
    }

    Context 'Error Handling' {

        It 'Handles already-migrated config gracefully' {
            $config = @{ configSchemaVersion = '1.0'; FFUDevelopmentPath = 'C:\FFU' }
            $result = Invoke-FFUConfigMigration -Config $config
            $result.Changes.Count | Should -Be 0
            $result.FromVersion | Should -Be '1.0'
        }
    }
}
```

**Note:** WPF MessageBox tests require mocking - use InModuleScope or conditional skip for non-interactive environments.
  </action>
  <verify>
Run tests: `Invoke-Pester -Path Tests/Unit/FFU.ConfigMigration.Integration.Tests.ps1 -Output Detailed`
All tests pass, minimum 15 integration test cases
  </verify>
  <done>
FFU.ConfigMigration.Integration.Tests.ps1 exists with:
- End-to-end migration tests
- Version comparison tests
- Deprecated property migration tests
- Error handling tests
- Forward compatibility tests
- Minimum 15 test cases
  </done>
</task>

<task type="auto">
  <name>Task 2: Update version.json with New Module</name>
  <files>FFUDevelopment/version.json</files>
  <action>
Update version.json to track the new FFU.ConfigMigration module and bump the main version.

**Changes:**

1. **Bump main version** (PATCH for new module):
   - Increment patch version (e.g., 1.3.x -> 1.3.x+1)

2. **Update buildDate** to current date (YYYY-MM-DD format)

3. **Add FFU.ConfigMigration to modules section**:
```json
"FFU.ConfigMigration": {
    "version": "1.0.0",
    "description": "Configuration file migration and schema versioning"
}
```

4. **Preserve all existing module entries** - do not modify other modules unless they were changed in this phase

**Example update pattern:**
```json
{
    "version": "1.3.13",
    "buildDate": "2026-01-20",
    "modules": {
        // ... existing modules ...
        "FFU.ConfigMigration": {
            "version": "1.0.0",
            "description": "Configuration file migration and schema versioning"
        }
    }
}
```
  </action>
  <verify>
- JSON valid: `Get-Content FFUDevelopment/version.json | ConvertFrom-Json`
- Module entry exists: `(Get-Content FFUDevelopment/version.json | ConvertFrom-Json).modules.'FFU.ConfigMigration'` not null
  </verify>
  <done>
version.json updated with:
- Incremented main version
- Current build date
- FFU.ConfigMigration module entry with v1.0.0
  </done>
</task>

<task type="auto">
  <name>Task 3: Run Full Test Suite and Verify</name>
  <files>Tests/Unit/FFU.ConfigMigration.Tests.ps1, Tests/Unit/FFU.ConfigMigration.Integration.Tests.ps1</files>
  <action>
Run the complete test suite for FFU.ConfigMigration to ensure all functionality works correctly.

**Steps:**

1. Run unit tests:
```powershell
Invoke-Pester -Path Tests/Unit/FFU.ConfigMigration.Tests.ps1 -Output Detailed
```

2. Run integration tests:
```powershell
Invoke-Pester -Path Tests/Unit/FFU.ConfigMigration.Integration.Tests.ps1 -Output Detailed
```

3. Verify module exports:
```powershell
Import-Module FFUDevelopment/Modules/FFU.ConfigMigration -Force
Get-Command -Module FFU.ConfigMigration
```

4. Verify schema update:
```powershell
$schema = Get-Content FFUDevelopment/config/ffubuilder-config.schema.json | ConvertFrom-Json
$schema.properties.configSchemaVersion | Should -Not -BeNullOrEmpty
```

5. Document test results:
- Total test count
- Pass/fail count
- Any skipped tests (with reason)

**Expected results:**
- All unit tests pass (minimum 20)
- All integration tests pass (minimum 15)
- Total test coverage >= 35 tests
- No regressions in existing tests
  </action>
  <verify>
All tests pass: `Invoke-Pester -Path Tests/Unit/FFU.ConfigMigration*.ps1 -PassThru | % { $_.FailedCount -eq 0 }`
  </verify>
  <done>
Test suite verified:
- Unit tests: X/Y passing
- Integration tests: X/Y passing
- Total coverage: 35+ tests for config migration
- No test failures
  </done>
</task>

</tasks>

<verification>
1. Integration tests run: `Invoke-Pester Tests/Unit/FFU.ConfigMigration.Integration.Tests.ps1 -PassThru`
2. version.json valid: `Get-Content FFUDevelopment/version.json | ConvertFrom-Json`
3. All config migration tests pass:
   ```powershell
   $results = Invoke-Pester -Path Tests/Unit/FFU.ConfigMigration*.ps1 -PassThru
   $results.FailedCount -eq 0
   ```
</verification>

<success_criteria>
- FFU.ConfigMigration.Integration.Tests.ps1 exists with 15+ tests
- version.json has FFU.ConfigMigration module entry
- All unit tests pass (20+ tests)
- All integration tests pass (15+ tests)
- Total test count >= 35 for config migration feature
</success_criteria>

<output>
After completion, create `.planning/phases/09-feature-config-migration/09-03-SUMMARY.md`
</output>
