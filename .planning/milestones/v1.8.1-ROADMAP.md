# Milestone v1.8.1: Bug Fixes

**Status:** SHIPPED 2026-01-20
**Phases:** 11-13
**Total Plans:** 5

## Overview

Fix critical bugs discovered during v1.8.0 testing:
- Windows Update preview filtering — exclude preview/beta updates by default
- VHDX drive letter stability — fix drive letter lost during unattend file copy

## Phases

### Phase 11: Windows Update Preview Filtering

**Goal**: Exclude preview/beta Windows Updates by default with opt-in capability

**Depends on**: None
**Plans**: 2 plans

Plans:
- [x] 11-01: Config schema and migration for IncludePreviewUpdates
- [x] 11-02: UI checkbox and build script filtering logic

**Details:**

Requirements:
- UPD-01: Build process excludes preview/beta Windows Updates by default (GA releases only)
- UPD-02: User can opt-in to include preview updates via UI checkbox in Updates tab
- UPD-03: `IncludePreviewUpdates` setting persisted in configuration file
- UPD-04: Config migration handles new `IncludePreviewUpdates` property (defaults to false)

Key Files:
- `BuildFFUVM.ps1` - Update search logic with PreviewFilter
- `BuildFFUVM_UI.xaml` - chkIncludePreviewUpdates checkbox
- `FFUUI.Core.Config.psm1` - Config save/load wiring
- `config/ffubuilder-config.schema.json` - Schema v1.1
- `FFU.ConfigMigration` - Migration handler

**Completed:** 2026-01-20

---

### Phase 12: VHDX Drive Letter Stability

**Goal**: Fix OS partition drive letter lost during unattend file copy and verification

**Depends on**: None
**Plans**: 2 plans

Plans:
- [x] 12-01: Create Set-OSPartitionDriveLetter utility function in FFU.Imaging
- [x] 12-02: Integrate drive letter guarantee into mount functions and verify providers

**Details:**

Requirements:
- VHDX-01: OS partition drive letter persists through unattend file copy and verification
- VHDX-02: Drive letter stability works with Hyper-V provider
- VHDX-03: Drive letter stability works with VMware provider

Key Files:
- `FFU.Imaging.psm1` - Set-OSPartitionDriveLetter utility
- `BuildFFUVM.ps1` - Invoke-MountScratchDisk integration
- `HyperVProvider.ps1` - MountVirtualDisk with retry/validation
- `VMwareProvider.ps1` - MountVirtualDisk with validation

**Completed:** 2026-01-20

---

### Phase 13: Fix UI Default for IncludePreviewUpdates

**Goal**: Close audit gap — ensure IncludePreviewUpdates checkbox initializes correctly on fresh UI launch

**Depends on**: Phase 11
**Plans**: 1 plan

Plans:
- [x] 13-01: Add IncludePreviewUpdates to Get-GeneralDefaults

**Details:**

Gap Closure:
- UPD-02 partial → complete (checkbox defaults to `$null` instead of `$false`)
- Integration: Get-GeneralDefaults → UI Checkbox wiring
- Flow: Phase 11 E2E flow completes at UI default initialization

Key Files:
- `FFUUI.Core/FFUUI.Core.psm1` - Get-GeneralDefaults function

**Completed:** 2026-01-20

---

## Milestone Summary

**Key Decisions:**

| ID | Decision | Rationale |
|----|----------|-----------|
| D-11-01-01 | Place IncludePreviewUpdates after UpdatePreviewCU | Logical grouping with update settings |
| D-11-02-01 | Apply -preview exclusion filter to search query string | Microsoft Update Catalog supports negative keywords |
| D-11-02-02 | UpdatePreviewCU explicit request is NOT filtered | User wants preview CU, do not exclude |
| D-12-01-01 | Place function after New-RecoveryPartition | Logical grouping with partition functions |
| D-12-01-02 | Use GPT type for OS partition detection | More reliable than labels |
| D-12-01-03 | Default preferred letter to W | Consistent with New-OSPartition |
| D-12-02-01 | Use NoteProperty to attach drive letter | Maintains backward compatibility |
| D-12-02-02 | Add retry logic with exponential backoff | Handles transient failures |
| D-12-02-03 | Add drive letter normalization to VMwareProvider | Ensures consistent X:\ format |
| D-13-01-01 | Place IncludePreviewUpdates after UpdatePreviewCU | Consistent with D-11-01-01 |

**Issues Resolved:**

- Windows Update preview filtering implemented (GA releases only by default)
- VHDX drive letter stability fixed (persists through mount/copy/verify)
- UI default initialization gap closed (IncludePreviewUpdates in Get-GeneralDefaults)

**Issues Deferred:**

- HP driver extraction exit code 1168 (deferred to future milestone)
- Dell CatalogPC.xml auto-download (deferred to future milestone)
- expand.exe large file handling (fallback works, deferred)

**Technical Debt Incurred:**

- OSPartitionDriveLetter NoteProperty assigned but not utilized by call sites (optional refactor)

---

*For current project status, see .planning/PROJECT.md*

---

*Archived: 2026-01-20 as part of v1.8.1 milestone completion*
